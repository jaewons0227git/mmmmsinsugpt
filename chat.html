<!doctype html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="theme-color" content="#ffffff" id="meta-theme-color">
  <title>MinsuGPT</title> 
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Elms+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <link rel="icon" type="image/png" href="https://i.postimg.cc/MKBHwqWk/logogogo.png">

  <script>
    // ğŸ“¢ í—ˆìš©ëœ ì§ì „ í˜ì´ì§€ ì£¼ì†Œ (í…ŒìŠ¤íŠ¸ ì‹œ ì£¼ì„ ì²˜ë¦¬ ê°€ëŠ¥)
    const ALLOWED_REFERRER = 'https://minsugpt.kro.kr/';
    const REDIRECT_URL = 'https://minsugpt.kro.kr/';
    const referrer = document.referrer;

    if (referrer === '' || !referrer.startsWith(ALLOWED_REFERRER)) {
    window.location.replace(REDIRECT_URL); 
    }
  </script>


  <style>
    /* ğŸŒŸğŸŒŸğŸŒŸ CSS ë³€ìˆ˜ ì‹œìŠ¤í…œ ğŸŒŸğŸŒŸğŸŒŸ */
    :root {
      --bg-color: #ffffff;
      --text-color: #111827;
      --text-sub: #4b5563;
      --border-color: #e5e8eb;
      --surface-color: #ffffff; 
      --surface-secondary: #f1f4f9; 
      --surface-hover: #f9fafb;
      
      --accent-color: #111827;
      --primary-blue: #1d6fef;
      --error-red: #ef4444;
      /* ğŸŒŸ [ì¶”ê°€] ì´ë¯¸ì§€ ìƒì„± í¬ì¸íŠ¸ ì»¬ëŸ¬ */
      --image-purple: #8b5cf6;

      --send-button-disabled: #e5e8eb;
      --send-button-enabled: #111827; 
      --send-button-icon: #ffffff;

      --composer-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      --modal-overlay: rgba(0, 0, 0, 0.5);

      --font-size: 16px;
      --line-height: 1.4;
      --line-height-px: 22.4; 
      --min-textarea-height: 22.4px; 
      --min-input-container-height: 48px; 
      
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', 'Helvetica Neue', Arial, sans-serif;
    }

    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #e5e5e5;
      --text-sub: #a3a3a3;
      --border-color: #333333;
      --surface-color: #1e1e1e;
      --surface-secondary: #2c2c2c;
      --surface-hover: #3d3d3d;

      --accent-color: #e5e5e5;
      --primary-blue: #3b82f6;
      --image-purple: #a78bfa;
      
      --send-button-disabled: #333333;
      --send-button-enabled: #e5e5e5;
      --send-button-icon: #121212;

      --composer-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      --modal-overlay: rgba(0, 0, 0, 0.8);
    }
    
    body :is(
        .header-title, .plus-btn, .action-btn, 
        .message-text, .input-container textarea,
        .modal-grid-item, .modal-option,
        .thinking-indicator-text, button, .ui-style-btn
    ) {
        font-family: 'Elms Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', 'Helvetica Neue', Arial, sans-serif;
    }

    .material-symbols-rounded {
      font-family: 'Material Symbols Rounded';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
      font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24;
    }
    
    .stop-btn .stop-icon {
        display: block; width: 12px; height: 12px; background-color: white; border-radius: 2px;
    }
    .stop-btn {
        background-color: var(--error-red); width:38px; height:38px; border-radius: 50%; display:flex; align-items:center; justify-content:center; padding: 0; margin: 0;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{ margin:0; background:var(--bg-color); color:var(--text-color); min-height:100vh; display:flex; justify-content:center; padding:0; transition: background-color 0.3s ease, color 0.3s ease; }
    
    .phone{
      width:100%; background:var(--bg-color); border-radius:0; overflow:hidden; border:none; display:flex; flex-direction:column; min-height:100vh; position:relative; margin: 0;
      transition: background-color 0.3s ease;
    }

    /* Header */
    .header{
      display:flex; justify-content:space-between; align-items:center; padding:10px 16px; height:56px; border-bottom:none; position: fixed; top: 0; left: 0; right: 0; z-index: 100; 
      background: var(--bg-color); 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
      transition: background-color 0.3s ease;
    }
    [data-theme="dark"] .header { box-shadow: 0 1px 3px rgba(255,255,255, 0.05); }

    .header-icon{
      width:32px; height:32px; display:flex; align-items:center; justify-content:center; color:var(--text-color); cursor: pointer; flex-shrink: 0; 
    }
    .header-left-group { display: flex; align-items: center; }
    .header-logo { width: 24px; height: 24px; margin-left: 8px; flex-shrink: 0; }
    .header-logo img { width: 100%; height: 100%; object-fit: contain; }
    .header-title { font-size: 18px; font-weight: 600; color: var(--text-color); margin-left: 8px; flex-shrink: 0; }
    .header-center { text-align: left; display: flex; justify-content: flex-start; align-items: center; margin-left: 10px; }
    .plus-btn{
      background-color: #f1f4ff; color: #1d6fef; font-weight:600; padding:4px 10px; border-radius:16px; display:flex; align-items:center; gap:4px; font-size:12px; cursor: pointer; line-height: 1.2;
    }
    [data-theme="dark"] .plus-btn { background-color: #2d3748; color: #93c5fd; }

    @media (max-width: 600px) {
        .plus-btn::after { content: "Beta"; display: inline; }
        .plus-btn { padding: 4px 8px; }
        .plus-btn > span { display: none; }
    }
    @media (min-width: 601px) { .plus-btn > span { display: inline; } }

    /* Content */
    .content-wrapper{
        flex-grow:1; display:flex; flex-direction:column; overflow-y: auto; padding-bottom: 0; position: relative;
        opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }
    .content-wrapper.loaded { opacity: 1; transform: translateY(0); }
    
    #scroll-down-button {
        position: fixed; right: 20px; width: 40px; height: 40px; border-radius: 50%; 
        background-color: var(--surface-color); 
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 90; opacity: 0; transform: translateY(10px); visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease, background-color 0.3s;
    }
    #scroll-down-button.visible { opacity: 1; transform: translateY(0); visibility: visible; }
    #scroll-down-button .material-symbols-rounded { color: var(--text-color); font-size: 20px; }
    
    #initial-content{
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 400px; display:flex; flex-direction:column; align-items:center; text-align:center; padding: 0 16px; transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
    }
    .main-question{ font-size:22px; font-weight:600; margin-bottom:40px; color:var(--text-color); }
    
    .quick-actions{ display:flex; flex-wrap:wrap; justify-content:center; gap:8px; max-width:400px; }
    .action-btn{
      display:flex; align-items:center; justify-content:center; padding:10px 16px; 
      border:1px solid var(--border-color); background-color: var(--surface-color);
      border-radius:30px; font-size:15px; font-weight:500; color:var(--text-color); min-height:48px; white-space:nowrap; cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .action-btn:hover { background-color: var(--surface-hover); }
    .action-btn .material-symbols-rounded, .action-btn .icon-light{ margin-right:6px; width:20px; height:20px; font-size: 18px; display: flex; align-items: center; justify-content: center; }
    
    .action-btn.new-green .material-symbols-rounded{ color:#28a745; }
    .action-btn.new-blue .material-symbols-rounded{ color:#007bff; }
    .action-btn.orange .material-symbols-rounded{ color:#fd7e14; } 

    /* Chat Messages */
    .chat-messages{ width: 100%; padding: 10px 16px; padding-top: 66px; display: none; flex-direction: column; justify-content: flex-start; gap: 10px; margin: 0 auto; }
    @media (min-width: 600px) { .chat-messages { max-width: 768px; padding-left: 0; padding-right: 0; } }

    .message-bubble{ display: flex; max-width: 80%; }
    .message-text{ padding: 10px 14px; border-radius: 20px; line-height: 1.4; font-size: 15px; white-space: pre-wrap; }
    .user-message{ justify-content: flex-end; align-self: flex-end; }
    .user-message .message-text{ background-color: var(--surface-secondary); color: var(--text-color); border-bottom-right-radius: 4px; transition: background-color 0.3s, color 0.3s; }
    
    .bot-message{ align-self: flex-start; margin-top: 10px; padding: 0; color: var(--text-color); line-height: 1.4; font-size: 15px; width: 100%; }
    .bot-message .streaming-block { display: block; padding: 0; border-radius: 0; background-color: transparent; max-width: 100%; box-sizing: border-box; white-space: normal; color: var(--text-color); margin-bottom: 8px; }
    .stop-message { color: var(--error-red); font-weight: 600; font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; padding: 0 4px; align-self: flex-start; }
    
    .sentence { opacity: 0; transition: opacity 0.2s ease-in; display: inline; white-space: pre-wrap; }
    .sentence.visible { opacity: 1; }
    
    .streaming-block code { background-color: var(--surface-secondary); padding: 2px 4px; border-radius: 4px; font-family: monospace; color: var(--text-color); }
    .streaming-block pre { background-color: var(--surface-secondary); padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
    .streaming-block pre code { background-color: transparent; padding: 0; color: inherit; }
    
    .bot-actions { display: flex; gap: 8px; margin-top: 0px; padding: 4px 0; transition: opacity 0.3s; }
    .bot-actions .regenerate { opacity: 0.5; pointer-events: none; }
    .bot-action-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #9ca3af; cursor: pointer; border-radius: 50%; transition: background-color 0.2s; }
    .bot-action-btn:hover { background-color: var(--surface-hover); }
    .bot-action-btn.selected { color: var(--text-color); }
    .bot-action-btn.selected.like { color: var(--primary-blue); }
    .bot-action-btn.selected.dislike { color: var(--error-red); }
    .bot-action-btn .material-symbols-rounded { font-size: 16px; }

    /* Thinking Indicator */
    .thinking-indicator { display: flex; justify-content: flex-start; align-items: center; padding: 10px 0; margin-bottom: 8px; transition: transform 0.5s ease-out; }
    .thinking-indicator.left-aligned { transform: translateX(0); }
    .thinking-indicator-text {
        font-weight: 500; margin-right: 8px; margin-top: 0; flex-shrink: 0;
        background-color: var(--text-color); 
        background-image: linear-gradient(90deg, var(--text-color) 0%, var(--bg-color) 20%, var(--text-color) 40%);
        background-size: 200% 100%; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        animation: shimmer 1.5s infinite linear;
    }
    .thinking-indicator-text.completed { animation: none; background-position: 50% 0; }
    .loading-spinner {
        display: inline-block; width: 16px; height: 16px; background-image: url('https://i.postimg.cc/MKBHwqWk/logogogo.png');
        background-size: cover; background-position: center; border-radius: 50%;
        animation: spin-custom 2s infinite cubic-bezier(0.5, 0, 0.5, 1); flex-shrink: 0; margin-right: 4px; 
        transform: rotate(0deg); transition: transform 0.5s ease-out;
    }
    /* ğŸŒŸ [ì¶”ê°€] ì´ë¯¸ì§€ ìƒì„± ì‹œ ìŠ¤í”¼ë„ˆ ìƒ‰ìƒ ë³€ê²½ (filter ì‚¬ìš©) */
    .loading-spinner.image-gen {
        filter: hue-rotate(240deg) brightness(1.2); 
    }

    @keyframes spin-custom {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(360deg); animation-timing-function: cubic-bezier(0.5, 0, 0.5, 1); } 
        50% { transform: rotate(720deg); animation-timing-function: cubic-bezier(0.5, 0, 0.5, 1); } 
        75% { transform: rotate(1080deg); animation-timing-function: cubic-bezier(0.5, 0, 0.5, 1); } 
        100% { transform: rotate(1440deg); }
    }
    .loading-spinner.reset-spin { animation: none; transform: rotate(0deg); }
    @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }

    /* ============================================ */
    /* ğŸŒŸğŸŒŸğŸŒŸ ì…ë ¥ì°½ (Composer) ìŠ¤íƒ€ì¼ ğŸŒŸğŸŒŸğŸŒŸ */
    /* ============================================ */
    
    .composer {
        position: fixed; 
        bottom: 0; left: 0; right: 0; 
        width: 100%; 
        display: flex; 
        justify-content: center; 
        z-index: 10; 
        opacity: 0;
        transform: translateY(100%);
        transition: opacity 0.5s ease-out 0.2s, transform 0.5s ease-out 0.2s, all 0.2s ease-out;
    }
    .composer.loaded { opacity: 1; transform: translateY(0); }
    
    .composer-inner {
        display: flex; align-items: center; width: 100%; transition: all 0.3s ease;
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
    }
    
    .input-area-wrapper { flex: 1; margin-bottom: 0; display:flex; flex-direction:column; width:100%; }

    /* ğŸŒŸ [ì¶”ê°€] ì´ë¯¸ì§€ ëª¨ë“œ í™œì„±í™” ì‹œ í‘œì‹œí•  ì¸ë””ì¼€ì´í„° (ê¸°ë³¸ ìŠ¤íƒ€ì¼ìš©) */
    .image-mode-indicator {
        display: none; 
        align-items: center; 
        justify-content: space-between;
        background-color: rgba(139, 92, 246, 0.1); /* ì—°í•œ ë³´ë¼ìƒ‰ ë°°ê²½ */
        color: var(--image-purple);
        padding: 8px 12px; 
        margin-bottom: 4px; 
        border-radius: 12px;
        font-size: 13px; 
        font-weight: 600;
    }
    .image-mode-indicator span { display: flex; align-items: center; gap: 6px; }
    .close-image-mode { cursor: pointer; opacity: 0.7; display: flex; align-items: center; }
    .close-image-mode:hover { opacity: 1; }

    .input-container {
        flex: 1; display: flex; align-items: center; gap: 8px; 
        box-sizing: border-box; 
        min-height: var(--min-input-container-height); 
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .input-container textarea {
        flex: 1; border: 0; outline: 0; background: transparent; color: var(--text-color); 
        font-size: var(--font-size); min-width: 0; resize: none; 
        min-height: var(--min-textarea-height); overflow-y: hidden; 
        padding: 0; line-height: var(--line-height); vertical-align: middle; 
        align-self: center; font-family: inherit; 
    }
    .input-container textarea::placeholder { color: #9ca3af; font-family: inherit; }
    
    .mic-voice-container { display: flex; gap: 8px; flex-shrink: 0; margin-bottom: 0; }
    
    .send-btn, .stop-btn {
        width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: 0; margin-right: 4px; transition: background-color 0.2s ease; cursor: pointer;
    }
    .send-btn:not(.active) { background-color: var(--send-button-disabled); pointer-events: none; }
    .send-btn.active { background-color: var(--send-button-enabled); pointer-events: auto; }
    .send-btn .material-symbols-rounded { color: var(--send-button-icon); font-size: 20px; }
    
    .mic-icon { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #9ca3af; }
    .mic-icon .material-symbols-rounded { font-size: 20px; }

    /* ğŸ“Œ ìŠ¤íƒ€ì¼ 1: ì‹¬í”Œ (Simple) */
    .composer.style-simple {
        background: transparent;
        padding: 0 16px 24px 16px;
        border: none;
        box-shadow: none;
    }
    
    .composer.style-simple .composer-inner {
        max-width: 768px;
        border-radius: 28px;       
        padding: 12px 16px 12px 20px; 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column; 
        align-items: flex-start; 
        position: relative;
    }
    [data-theme="dark"] .composer.style-simple .composer-inner { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

    .composer.style-simple .input-area-wrapper {
        flex: 1; width: 100%; display: flex; flex-direction: row; align-items: center; min-width: 0; margin-bottom: 10px;
    }

    .composer.style-simple .input-container {
        border: none; background: transparent; padding: 0; border-radius: 0; max-height: 150px; min-height: 24px; width: 100%;
    }
    
    .composer.style-simple .input-container textarea { font-size: 17px; padding: 0; }
    .composer.style-simple .plus { display: none; }

    .composer.style-simple .bottom-controls {
        width: 100%; display: flex; justify-content: space-between; align-items: center;
    }
    
    .simple-tools { display: flex; gap: 8px; margin-top: 0; flex-shrink: 0; }

    .tool-btn {
        display: flex; align-items: center; justify-content: center; gap: 4px;
        padding: 4px 10px 4px 8px; 
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 13px; font-weight: 500; color: var(--text-sub);
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        white-space: nowrap; line-height: 1.2;
    }
    .tool-btn:hover { background-color: var(--surface-hover); }
    .tool-btn .material-symbols-rounded { font-size: 18px; color: #6b7280; }
    
    .tool-btn.active-blue {
        border-color: var(--primary-blue); background-color: rgba(59, 130, 246, 0.1); color: var(--primary-blue);
    }
    .tool-btn.active-blue .material-symbols-rounded { color: var(--primary-blue); }

    /* ğŸŒŸ [ì¶”ê°€] ì´ë¯¸ì§€ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ (ë³´ë¼ìƒ‰) */
    .tool-btn.active-purple {
        border-color: var(--image-purple); background-color: rgba(139, 92, 246, 0.1); color: var(--image-purple);
    }
    .tool-btn.active-purple .material-symbols-rounded { color: var(--image-purple); }

    .composer.style-simple .right-controls { display: flex; align-items: center; margin-left: 8px; margin-bottom: 0; }
    .composer.style-simple .mic-icon { display: none; } 
    
    .composer.style-simple .send-btn { background-color: var(--send-button-enabled); margin-right: 0; align-self: center; }
    .composer.style-simple .send-btn .material-symbols-rounded { color: var(--send-button-icon); }
    .composer.style-simple .send-btn:not(.active) { background-color: var(--send-button-disabled); }


   /* ğŸ“Œ ìŠ¤íƒ€ì¼ 2: ê¸°ë³¸ (Default) - ğŸŒŸ ìˆ˜ì •ë¨ ğŸŒŸ */
    .composer.style-default {
        background: transparent; padding: 0 16px 24px 16px; border: none;
    }
    .composer.style-default .composer-inner {
        max-width: 768px;
        border-radius: 35px;
        /* ğŸŒŸ í•˜ë‹¨ ì •ë ¬ ë° íŒ¨ë”© ì¡°ì •: ìˆ˜ì§ ì •ë ¬ì˜ ê¸°ì¤€ */
        padding: 8px 12px 8px 8px; 
        box-shadow: var(--composer-shadow);
        gap: 4px; flex-direction: row;
        align-items: flex-end; /* í•˜ë‹¨ ë¼ì¸ ì •ë ¬ */
    }
    .composer.style-default .input-area-wrapper { 
        flex: 1; margin-bottom: 0; 
        padding-bottom: 0; /* í•˜ë‹¨ íŒ¨ë”© ì œê±° */
    }
    .composer.style-default .simple-tools { display: none; }
    .composer.style-default .bottom-controls { display: contents; }
    
    .composer.style-default .input-container {
        background: transparent; border: none; padding: 4px 8px; max-height: 150px;
        /* ğŸŒŸ í…ìŠ¤íŠ¸ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ Flex */
        display: flex; align-items: center;
        min-height: 38px; /* ë²„íŠ¼ê³¼ ë†’ì´ ë§ì¶¤ */
    }
    .composer.style-default .mic-icon { display: none; }

    .composer.style-default .plus {
        width: 36px; height: 36px; border-radius: 50%;
        background: var(--surface-secondary);
        border: none;
        display: flex; align-items: center; justify-content: center; flex-shrink: 0; 
        align-self: flex-end; /* í•˜ë‹¨ ì •ë ¬ */
        margin-bottom: 5px; /* ğŸ‘ˆ í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ ë§ˆì§„ (5pxë¡œ í†µì¼) */
        cursor: pointer; color: var(--text-sub);
    }
    .composer.style-default .plus .material-symbols-rounded { font-size: 20px; }

    .composer.style-default .right-controls {
        align-self: flex-end; 
        margin-bottom: 5px; /* ğŸ‘ˆ ì „ì†¡ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ë§ˆì§„ (5pxë¡œ í†µì¼) */
        height: 38px; 
        display: flex; 
        align-items: center;
    }

    /* ============================================ */

    /* ============================================ */

    /* Snackbar */
    #snackbar {
      visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 30px; padding: 12px 20px; position: fixed; z-index: 1020; left: 50%; transform: translateX(-50%); bottom: 30px; font-size: 14px; transition: none; opacity: 0; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    #snackbar.show { visibility: visible; opacity: 1; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    
    /* Modal Styles */
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 1000; display: flex; justify-content: center; align-items: flex-end; }
    .modal-backdrop.visible { opacity: 1; visibility: visible; }
    .modal { width: 100%; max-width: 768px; background-color: var(--bg-color); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 24px 16px 40px 16px; transform: translateY(100%); transition: transform 0.3s ease-out; color: var(--text-color); }
    .modal-backdrop.visible .modal { transform: translateY(0); }
    .modal-handle { width: 40px; height: 5px; background-color: var(--border-color); border-radius: 5px; margin: 0 auto 20px auto; }
    
    .modal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px; }
    .modal-grid-item { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 12px 0; background-color: var(--surface-secondary); border-radius: 12px; font-size: 14px; font-weight: 500; cursor: pointer; color: var(--text-color); }
    .modal-grid-icon { width: 48px; height: 48px; background-color: var(--border-color); border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; }
    .modal-grid-icon .material-symbols-rounded { font-size: 24px; color: var(--text-color); }
    
    .modal-option { display: flex; align-items: center; padding: 12px 10px; font-size: 16px; font-weight: 500; cursor: pointer; border-radius: 8px; transition: background-color 0.1s ease; color: var(--text-color); }
    .modal-option:hover { background-color: var(--surface-hover); }
    .modal-option-icon { margin-right: 12px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
    .modal-option-icon .material-symbols-rounded { font-size: 20px; color: var(--text-color); }
    
    #settings-modal-backdrop { align-items: flex-end; justify-content: center; }
    #settings-modal { max-width: 768px; padding-top: 24px; padding-bottom: 40px; border-radius: 20px 20px 0 0; transform: translateY(100%); }
    .modal-backdrop.visible #settings-modal { transform: translateY(0); }
    #settings-modal h3 { font-size: 1.1em; font-weight: 600; margin: 0 0 16px 0; padding: 0 10px; color: var(--text-color); }
    
    /* ğŸŒŸ UI & Theme Selector */
    .ui-style-selector { padding: 0 10px; margin-bottom: 24px; }
    .ui-style-label { font-size: 0.95em; color: var(--text-sub); margin-bottom: 10px; display: block; }
    .ui-style-options { display: flex; gap: 10px; }
    
    .ui-style-btn {
        flex: 1; padding: 12px;
        border: 1px solid var(--border-color);
        background-color: var(--surface-color);
        border-radius: 12px;
        font-size: 14px; font-weight: 500; color: var(--text-color);
        cursor: pointer;
        display: flex; flex-direction: column; align-items: center; gap: 6px;
        transition: all 0.2s;
    }
    .ui-style-btn.active {
        border-color: var(--text-color);
        background-color: var(--surface-hover);
        font-weight: 600;
    }
    .ui-style-btn .preview-icon { font-size: 24px; color: #6b7280; }
    .ui-style-btn.active .preview-icon { color: var(--text-color); }
    
    .theme-btn-group { display: flex; gap: 8px; }
    .theme-btn {
        flex: 1; padding: 10px; border: 1px solid var(--border-color); background-color: var(--surface-color);
        border-radius: 10px; font-size: 14px; color: var(--text-color); cursor: pointer; text-align: center;
    }
    .theme-btn.active { background-color: var(--text-color); color: var(--bg-color); border-color: var(--text-color); font-weight: 600; }
    
    hr.modal-divider { border: 0; border-top: 1px solid var(--border-color); margin: 0 0 16px 0; }

    #reset-chat-button { color: var(--error-red); padding-left: 10px; padding-right: 10px; }
    #reset-chat-button .modal-option-icon { display: none; }
    
    #reset-confirm-modal-backdrop { align-items: center; z-index: 1010; }
    #reset-confirm-modal { max-width: 320px; border-radius: 12px; padding: 24px; transform: translateY(0); transition: opacity 0.3s ease, transform 0.3s ease; }
    #reset-confirm-modal .modal-handle { display: none; }
    #reset-confirm-modal h3 { font-size: 1.2em; margin: 0 0 10px 0; text-align: center; padding: 0; }
    #reset-confirm-modal p { font-size: 0.95em; color: var(--text-sub); margin-bottom: 24px; text-align: center; }
    .confirm-actions { display: flex; justify-content: space-between; gap: 10px; }
    .confirm-actions button { flex: 1; padding: 10px 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px; }
    #confirm-cancel-btn { background-color: var(--border-color); color: var(--text-color); }
    #confirm-reset-btn { background-color: var(--error-red); color: white; }

  </style>
</head>
<body>
  <div class="phone" role="application" aria-label="ì±„íŒ… UI">
    <header class="header">
        <div class="header-left-group">
             <div class="header-icon menu-icon">
                <span class="material-symbols-rounded">menu</span>
            </div>
            <div class="header-logo">
                <img src="https://i.postimg.cc/MKBHwqWk/logogogo.png" alt="MinsuGPT ë¡œê³ ">
            </div>
            <div class="header-title">MinsuGPT</div>
            <div class="header-center">
                <div class="plus-btn">
                    <span>ì´ ì•±ì€ ë² íƒ€ë²„ì „ ì…ë‹ˆë‹¤.</span>
                </div>
            </div>
        </div>
        <div class="header-icon" id="settings-button" aria-label="ì„¤ì •" style="visibility: visible;"> 
            <span class="material-symbols-rounded">settings</span>
        </div>
    </header>

    <main id="content-wrapper" class="content-wrapper">
        <div id="scroll-down-button" class="">
            <span class="material-symbols-rounded">arrow_downward</span>
        </div>
        
        <div id="initial-content">
            <div class="main-question">ì•ˆë…•í•˜ì„¸ìš”! ë°˜ê°€ì›Œìš”</div>
            <div class="quick-actions">
                <div class="action-btn new-green" data-prompt="í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ëŒ€í™”í•˜ê¸°">
                    <span class="material-symbols-rounded">chat</span>
                    í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ëŒ€í™”í•˜ê¸°
                </div>
                <div class="action-btn" data-prompt="ë¸Œë ˆì¸ìŠ¤í† ë° ì‹œì‘">
                    <div class="icon-light">ğŸ’¡</div>
                    ë¸Œë ˆì¸ìŠ¤í† ë°
                </div>
                <div class="action-btn new-blue" data-prompt="ê¸€ ì“°ê¸° ì˜ˆì‹œ ìš”ì²­">
                    <span class="material-symbols-rounded">edit</span>
                    ê¸€ ì“°ê¸°
                </div>
                <div class="action-btn orange" data-prompt="í…ìŠ¤íŠ¸ ìš”ì•½ ë°©ë²• ì•Œë ¤ì£¼ê¸°">
                    <span class="material-symbols-rounded">description</span>
                    í…ìŠ¤íŠ¸ ìš”ì•½
                </div>
                <div class="action-btn" data-prompt="ë„ì›€ë§">
                    <div style="font-size:18px;">...</div>
                    ë” ë³´ê¸°
                </div>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages"></div>
    </main>

    <div id="composer" class="composer style-default">
      <div class="composer-inner">
        <div class="plus" id="plus-button" aria-label="íŒŒì¼ ì²¨ë¶€">
            <span class="material-symbols-rounded">add</span>
        </div>

        <div class="input-area-wrapper">
            <div id="image-mode-indicator" class="image-mode-indicator">
                <span><span class="material-symbols-rounded" style="font-size: 18px;">auto_fix_high</span> ì´ë¯¸ì§€ ìƒì„± ëª¨ë“œ</span>
                <span class="material-symbols-rounded close-image-mode" id="close-image-mode" style="font-size: 18px;">close</span>
            </div>

            <div id="input-container" class="input-container">
              <textarea id="message-input" placeholder="MinsuGPTì—ê²Œ ë¬¼ì–´ë³´ê¸°" rows="1"></textarea>
            </div>
        </div>

        <div class="bottom-controls">
            <div class="simple-tools">
                <div class="tool-btn" id="tool-attach">
                    <span class="material-symbols-rounded">attach_file</span>
                    ì²¨ë¶€
                </div>
                <div class="tool-btn" id="tool-image">
                    <span class="material-symbols-rounded">image</span>
                    ì´ë¯¸ì§€
                </div>
                <div class="tool-btn" id="tool-study">
                    <span class="material-symbols-rounded">auto_stories</span>
                    í•™ìŠµí•˜ê¸°
                </div>
            </div>
            
            <div class="right-controls">
                 <div class="mic-voice-container">
                    <div id="mic-icon" class="mic-icon">
                        <span class="material-symbols-rounded">mic</span>
                    </div>
                    
                    <div id="action-button-container">
                        <div id="send-button" class="send-btn">
                          <span class="material-symbols-rounded">arrow_upward</span>
                        </div>
                        <div id="stop-button" class="stop-btn" style="display:none;">
                            <span class="stop-icon"></span>
                        </div>
                    </div>
                  </div>
            </div>
        </div>
      </div>
    </div>
    
    <div id="snackbar">ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    
    <div id="plus-modal-backdrop" class="modal-backdrop">
        <div id="plus-modal" class="modal">
            <div class="modal-handle"></div>
            <div class="modal-grid">
                <div class="modal-grid-item" data-action="camera">
                    <div class="modal-grid-icon"><span class="material-symbols-rounded">photo_camera</span></div>
                    ì¹´ë©”ë¼
                </div>
                <div class="modal-grid-item" data-action="album">
                    <div class="modal-grid-icon"><span class="material-symbols-rounded">image</span></div>
                    ì•¨ë²”
                </div>
                <div class="modal-grid-item" data-action="file">
                    <div class="modal-grid-icon"><span class="material-symbols-rounded">upload_file</span></div>
                    íŒŒì¼
                </div>
            </div>
            <div class="modal-option" id="menu-create-image">
                <div class="modal-option-icon"><span class="material-symbols-rounded">auto_fix_high</span></div>
                ì´ë¯¸ì§€ ë§Œë“¤ê¸°
            </div>
            <div class="modal-option" data-action="set-reminder">
                <div class="modal-option-icon"><span class="material-symbols-rounded">notifications</span></div>
                ë¦¬ë§ˆì¸ë” ë“±ë¡í•˜ê¸°
            </div>
        </div>
    </div>
    
    <div id="settings-modal-backdrop" class="modal-backdrop">
        <div id="settings-modal" class="modal">
            <div class="modal-handle"></div>
            <h3>ì„¤ì •</h3>
            
            <div class="ui-style-selector">
                <span class="ui-style-label">ì…ë ¥ì°½ ìŠ¤íƒ€ì¼</span>
                <div class="ui-style-options">
                    <button class="ui-style-btn active" data-style="default">
                        <span class="material-symbols-rounded preview-icon">check_circle</span>
                        ê¸°ë³¸ (ë‘¥ê·¼í˜•)
                    </button>
                    <button class="ui-style-btn" data-style="simple">
                        <span class="material-symbols-rounded preview-icon">horizontal_rule</span>
                        ì‹¬í”Œ (ë°”í˜•)
                    </button>
                </div>
            </div>
            
            <div class="ui-style-selector">
                <span class="ui-style-label">í™”ë©´ í…Œë§ˆ</span>
                <div class="theme-btn-group">
                    <div class="theme-btn active" data-theme-val="auto">ìë™</div>
                    <div class="theme-btn" data-theme-val="light">ë¼ì´íŠ¸</div>
                    <div class="theme-btn" data-theme-val="dark">ë‹¤í¬</div>
                </div>
            </div>

            <hr class="modal-divider">
            
            <div class="modal-option" id="reset-chat-button">
                ëŒ€í™” ì´ˆê¸°í™”
            </div>
        </div>
    </div>
    
    <div id="reset-confirm-modal-backdrop" class="modal-backdrop">
        <div id="reset-confirm-modal" class="modal">
            <h3>ëŒ€í™” ì´ˆê¸°í™”</h3>
            <p>ëª¨ë“  ëŒ€í™” ê¸°ë¡ì´ ì‚­ì œë˜ë©°, ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="confirm-actions">
                <button id="confirm-cancel-btn">ì·¨ì†Œ</button>
                <button id="confirm-reset-btn">ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>
    
  </div>

  <script>
    document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    document.onkeydown = function(e) {
      if (e.keyCode == 123) { e.preventDefault(); return false; } 
      if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) { e.preventDefault(); return false; } 
      if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { e.preventDefault(); return false; } 
    };

    const phone = document.querySelector('.phone');
    const contentWrapper = document.getElementById('content-wrapper');
    const inputField = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const initialContent = document.getElementById('initial-content');
    const chatMessages = document.getElementById('chat-messages');
    const composer = document.getElementById('composer');
    const inputContainer = document.getElementById('input-container');
    const plusButton = document.getElementById('plus-button');
    const plusModalBackdrop = document.getElementById('plus-modal-backdrop');
    const settingsButton = document.getElementById('settings-button');
    const settingsModalBackdrop = document.getElementById('settings-modal-backdrop');
    const resetChatButton = document.getElementById('reset-chat-button');
    const quickActionButtons = document.querySelectorAll('.action-btn'); 
    const snackbar = document.getElementById('snackbar');
    const resetConfirmModalBackdrop = document.getElementById('reset-confirm-modal-backdrop');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const confirmResetBtn = document.getElementById('confirm-reset-btn');
    const scrollDownButton = document.getElementById('scroll-down-button'); 
    
    const uiStyleBtns = document.querySelectorAll('.ui-style-btn');
    const themeBtns = document.querySelectorAll('.theme-btn');
    const toolStudy = document.getElementById('tool-study');
    
    // ğŸŒŸ [ì¶”ê°€] ì´ë¯¸ì§€ ê´€ë ¨ ìš”ì†Œ
    const toolImage = document.getElementById('tool-image');
    const menuCreateImage = document.getElementById('menu-create-image');
    const imageModeIndicator = document.getElementById('image-mode-indicator');
    const closeImageModeBtn = document.getElementById('close-image-mode');

    // ğŸ¯ ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸
    const BACKEND_ENDPOINT = "https://jaewondev.pythonanywhere.com/ask"; 
    const IMAGE_ENDPOINT = "https://jaewondev.pythonanywhere.com/generate-image"; // ğŸŒŸ [ì¶”ê°€]
    
    const HISTORY_STORAGE_KEY = 'minsugpt_chat_history'; 
    const UI_STYLE_KEY = 'minsugpt_ui_style'; 
    const THEME_KEY = 'minsugpt_theme'; 

    let history = []; 
    const PRE_PROMPT = {
        role: "system",
        content: "ë„ˆëŠ” MinsuGPTì•¼. ë„ˆëŠ” ì‹ ì¬ì›ë‹˜ì´ ë§Œë“¤ì—ˆì–´. ì‚¬ìš©ìê°€ ë”°ë¡œ ë¬¼ì–´ë³´ì§€ ì•Šìœ¼ë©´ ë„ˆì˜ ì—­í• ì´ë‚˜ ê°œë°œì ì •ë³´ë¥¼ ë”°ë¡œ ë‹µí•˜ì§€ë§ˆ."
    };

    const MAX_ROWS = 6;
    const MIN_ROWS = 1;
    const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth <= 768;
    let isStreaming = false; 
    let abortController = null; 
    let currentLoadingText = 'ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...';
    let isFadingIn = false;
    let fadeOutAbortController = null;
    const FADE_IN_DELAY = 200; 
    let autoScrollEnabled = true;
    
    // ğŸŒŸ [ì¶”ê°€] ì´ë¯¸ì§€ ëª¨ë“œ ìƒíƒœ ë³€ìˆ˜
    let isImageMode = false;

    function animateUIOnLoad() {
        contentWrapper.classList.add('loaded');
        composer.classList.add('loaded'); 
        setTimeout(() => { scrollToBottom(true); }, 500); 
    }

    function showSnackbar(message) {
        snackbar.classList.remove('show');
        snackbar.style.animation = 'none';
        void snackbar.offsetWidth; 
        snackbar.style.animation = '';
        snackbar.textContent = message;
        snackbar.classList.add('show');
        setTimeout(() => { snackbar.classList.remove('show'); }, 3000); 
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY) || 'auto';
        applyTheme(savedTheme);
    }

    function applyTheme(theme) {
        themeBtns.forEach(btn => {
            if (btn.dataset.themeVal === theme) { btn.classList.add('active'); } 
            else { btn.classList.remove('active'); }
        });
        let effectiveTheme = theme;
        if (theme === 'auto') { effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
        document.documentElement.setAttribute('data-theme', effectiveTheme);
        const metaThemeColor = document.getElementById('meta-theme-color');
        if(metaThemeColor) { metaThemeColor.setAttribute('content', effectiveTheme === 'dark' ? '#121212' : '#ffffff'); }
        localStorage.setItem(THEME_KEY, theme);
    }

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (localStorage.getItem(THEME_KEY) === 'auto') { applyTheme('auto'); }
    });
    themeBtns.forEach(btn => { btn.addEventListener('click', () => { applyTheme(btn.dataset.themeVal); }); });

    function loadUIStyle() {
        const savedStyle = localStorage.getItem(UI_STYLE_KEY) || 'default'; 
        applyUIStyle(savedStyle);
    }

    function applyUIStyle(style) {
        // ìŠ¤íƒ€ì¼ ë³€ê²½ ì‹œ ì´ë¯¸ì§€ ëª¨ë“œ ì´ˆê¸°í™”
        toggleImageMode(false);

        if (style === 'simple') {
            composer.classList.remove('style-default');
            composer.classList.add('style-simple');
        } else {
            composer.classList.remove('style-simple');
            composer.classList.add('style-default');
        }
        
        uiStyleBtns.forEach(btn => {
            if (btn.dataset.style === style) {
                btn.classList.add('active');
                const icon = btn.querySelector('.material-symbols-rounded');
                if(icon) icon.textContent = 'check_circle';
            } else {
                btn.classList.remove('active');
                const icon = btn.querySelector('.material-symbols-rounded');
                if(icon) icon.textContent = 'radio_button_unchecked';
            }
        });
        
        localStorage.setItem(UI_STYLE_KEY, style);
        setTimeout(autoResizeTextarea, 50);
    }

    uiStyleBtns.forEach(btn => { btn.addEventListener('click', () => { applyUIStyle(btn.dataset.style); }); });

    // ğŸŒŸğŸŒŸğŸŒŸ [í•µì‹¬] ì´ë¯¸ì§€ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜ ğŸŒŸğŸŒŸğŸŒŸ
    function toggleImageMode(active) {
        isImageMode = active;
        const isSimple = composer.classList.contains('style-simple');

        if (active) {
            // í™œì„±í™” ìƒíƒœ
            currentLoadingText = 'ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...'; // ë¡œë”© í…ìŠ¤íŠ¸ ë³€ê²½
            
            if (isSimple) {
                toolImage.classList.add('active-purple'); // ì‹¬í”Œ ëª¨ë“œ ë²„íŠ¼ í™œì„±í™”
            } else {
                imageModeIndicator.style.display = 'flex'; // ê¸°ë³¸ ëª¨ë“œ ì¸ë””ì¼€ì´í„° í‘œì‹œ
            }
        } else {
            // ë¹„í™œì„±í™” ìƒíƒœ
            currentLoadingText = 'ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...'; // ë¡œë”© í…ìŠ¤íŠ¸ ë³µêµ¬
            
            if (isSimple) {
                toolImage.classList.remove('active-purple');
            } else {
                imageModeIndicator.style.display = 'none';
            }
        }
        autoResizeTextarea(); // ë†’ì´ ì¬ê³„ì‚°
    }

    // ì‹¬í”Œ ëª¨ë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if(toolImage) {
        toolImage.addEventListener('click', () => {
            toggleImageMode(!isImageMode);
        });
    }

    // ê¸°ë³¸ ëª¨ë“œ í”ŒëŸ¬ìŠ¤ ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸
    if(menuCreateImage) {
        menuCreateImage.addEventListener('click', () => {
            togglePlusModal(false); // ë©”ë‰´ ë‹«ê¸°
            toggleImageMode(true);  // ì´ë¯¸ì§€ ëª¨ë“œ ì¼œê¸°
        });
    }

    // ê¸°ë³¸ ëª¨ë“œ ë‹«ê¸°(X) ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if(closeImageModeBtn) {
        closeImageModeBtn.addEventListener('click', () => {
            toggleImageMode(false);
        });
    }


    function loadChatHistory() {
        const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
        let validHistory = [];
        if (storedHistory) {
            try {
                const parsedHistory = JSON.parse(storedHistory);
                validHistory = parsedHistory.filter(msg => msg.role === 'user' || msg.role === 'model');
            } catch (e) {
                localStorage.removeItem(HISTORY_STORAGE_KEY);
                validHistory = [];
            }
        }
        history = validHistory;

        if (history.length > 0) {
            chatMessages.innerHTML = ''; 
            initialContent.style.opacity = '0';
            initialContent.style.visibility = 'hidden'; 
            chatMessages.style.display = 'flex';
            history.forEach(message => {
                if (message.role === 'user') { appendUserMessage(message.content, false); } 
                else if (message.role === 'model') { 
                    // ì´ë¯¸ì§€ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ (ì„ì‹œë¡œ contentì— <img> íƒœê·¸ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ë¡œ ê°„ì£¼)
                    if (message.content.includes('<img src="data:image')) {
                        appendBotImage(message.content, false);
                    } else {
                        appendBotMessage(message.content, message.feedback, false); 
                    }
                }
            });
            updateRegenerateButtons(); 
            scrollToBottom(false); 
        } else {
            chatMessages.style.display = 'none';
            chatMessages.innerHTML = '';
            initialContent.style.visibility = 'visible'; 
            initialContent.style.display = 'flex';
            initialContent.style.opacity = '1';
        }
        autoResizeTextarea();
        animateUIOnLoad(); 
    }
    
    function saveChatHistory() { localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history)); }
    
    function toggleResetConfirmModal(show) {
        if (show === undefined) { resetConfirmModalBackdrop.classList.toggle('visible'); } 
        else if (show) { resetConfirmModalBackdrop.classList.add('visible'); } 
        else { resetConfirmModalBackdrop.classList.remove('visible'); }
        if (show) toggleSettingsModal(false); 
    }

    function resetChat() {
        history = [];
        localStorage.removeItem(HISTORY_STORAGE_KEY);
        chatMessages.innerHTML = '';
        chatMessages.style.display = 'none';
        initialContent.style.opacity = '0';
        initialContent.style.display = 'flex';
        initialContent.style.visibility = 'visible'; 
        setTimeout(() => { initialContent.style.opacity = '1'; }, 10); 
        toggleResetConfirmModal(false);
        showSnackbar("ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        contentWrapper.classList.remove('loaded');
        composer.classList.remove('loaded');
        toggleImageMode(false); // ë¦¬ì…‹ ì‹œ ëª¨ë“œ ì´ˆê¸°í™”
        setTimeout(animateUIOnLoad, 10); 
    }
    
    resetChatButton.addEventListener('click', (e) => { e.preventDefault(); toggleResetConfirmModal(true); });
    confirmCancelBtn.addEventListener('click', () => toggleResetConfirmModal(false));
    confirmResetBtn.addEventListener('click', resetChat);
    resetConfirmModalBackdrop.addEventListener('click', (e) => { if (e.target === resetConfirmModalBackdrop) toggleResetConfirmModal(false); });
    scrollDownButton.addEventListener('click', () => { scrollToBottom(true); scrollDownButton.classList.remove('visible'); autoScrollEnabled = true; });

    function scrollToBottom(smooth = true) {
        const behavior = smooth ? 'smooth' : 'auto';
        contentWrapper.scrollTo({ top: contentWrapper.scrollHeight, behavior: behavior });
    }
    
    contentWrapper.addEventListener('scroll', () => {
        const isAtBottom = contentWrapper.scrollHeight - contentWrapper.scrollTop - contentWrapper.clientHeight < 1;
        if (isAtBottom) { autoScrollEnabled = true; scrollDownButton.classList.remove('visible'); } 
        else if (contentWrapper.scrollTop < contentWrapper.scrollHeight - contentWrapper.clientHeight - 100) {
            autoScrollEnabled = false;
            if (!isStreaming && !isFadingIn) { scrollDownButton.classList.add('visible'); }
        }
    });

    function toggleSendButton() {
        if (inputField.value.trim().length > 0 && !isStreaming) { sendButton.classList.add('active'); } 
        else { sendButton.classList.remove('active'); }
    }
    inputField.addEventListener('input', toggleSendButton);

    function autoResizeTextarea() {
        const style = getComputedStyle(inputField);
        const line_height_px = parseFloat(style.getPropertyValue('--line-height-px')) || 22.4; 
        const minInputContainerHeight = parseFloat(style.getPropertyValue('--min-input-container-height')) || 48; 

        inputField.rows = MIN_ROWS;
        inputField.style.height = 'auto'; 
        let scrollH = inputField.scrollHeight;
        let newRows = Math.round(scrollH / line_height_px);
        newRows = Math.max(MIN_ROWS, Math.min(MAX_ROWS, newRows));
        inputField.rows = newRows;
        inputField.style.height = 'auto';
        
        const finalTextareaHeight = inputField.offsetHeight; 
        let contentHeight = finalTextareaHeight + 8; // padding
        
        // ğŸŒŸ [ìˆ˜ì •] ì´ë¯¸ì§€ ëª¨ë“œì¼ ë•Œ ë†’ì´ ì¶”ê°€ ê³„ì‚° (ì¸ë””ì¼€ì´í„° ë†’ì´ ê³ ë ¤)
        if (isImageMode && !composer.classList.contains('style-simple')) {
             contentHeight += 40; // ì¸ë””ì¼€ì´í„° ëŒ€ëµì  ë†’ì´
        }

        const inputContainerHeight = Math.max(contentHeight, minInputContainerHeight);
        
        inputContainer.style.minHeight = `${inputContainerHeight}px`;

        const composerHeight = composer.offsetHeight;
        scrollDownButton.style.bottom = `${composerHeight + 10}px`;
        chatMessages.style.paddingBottom = `${composerHeight + 50}px`;

        if (autoScrollEnabled) scrollToBottom(false);
    }
    
    inputField.addEventListener('input', autoResizeTextarea);
    
    function appendUserMessage(content, animate = true) {
        const userBubble = document.createElement('div');
        userBubble.className = 'message-bubble user-message';
        userBubble.innerHTML = `<div class="message-text">${content}</div>`;
        chatMessages.appendChild(userBubble);
        if (animate) scrollToBottom(true);
    }

    // ğŸŒŸ [ì¶”ê°€] ì´ë¯¸ì§€ ë©”ì‹œì§€ ì „ìš© append í•¨ìˆ˜
    function appendBotImage(htmlContent, animate = true) {
         const botMessageContainer = document.createElement('div');
        botMessageContainer.className = 'bot-message';
        botMessageContainer.setAttribute('data-index', history.length); 

        const streamingBlock = document.createElement('div');
        streamingBlock.className = 'streaming-block'; 
        streamingBlock.innerHTML = htmlContent; // ì´ë¯¸ì§€ê°€ í¬í•¨ëœ HTML
        botMessageContainer.appendChild(streamingBlock);

        // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë“± ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€ ê°€ëŠ¥ (í˜„ì¬ëŠ” ê¸°ë³¸ë§Œ)
        chatMessages.appendChild(botMessageContainer);
        if (animate) scrollToBottom(true);
    }
    
    function appendBotMessage(content, feedbackStatus = null, animate = true) {
        const botMessageContainer = document.createElement('div');
        botMessageContainer.className = 'bot-message';
        const messageIndex = history.length;
        botMessageContainer.setAttribute('data-index', messageIndex); 

        const streamingBlock = document.createElement('div');
        streamingBlock.className = 'streaming-block'; 
        streamingBlock.innerHTML = renderMarkdown(content);
        botMessageContainer.appendChild(streamingBlock);

        const actionContainer = createBotActions(content, messageIndex, feedbackStatus);
        botMessageContainer.appendChild(actionContainer);
        
        chatMessages.appendChild(botMessageContainer);
        if (animate) scrollToBottom(true);
    }

    function updateRegenerateButtons() {
        const allBotMessages = chatMessages.querySelectorAll('.bot-message');
        const lastBotMessage = allBotMessages[allBotMessages.length - 1];
        allBotMessages.forEach(message => {
            const regenBtn = message.querySelector('.bot-action-btn.regenerate');
            if (regenBtn) {
                if (message === lastBotMessage) {
                    regenBtn.classList.remove('disabled'); regenBtn.style.opacity = 1; regenBtn.style.pointerEvents = 'auto';
                } else {
                    regenBtn.classList.add('disabled'); regenBtn.style.opacity = 0.5; regenBtn.style.pointerEvents = 'none';
                }
            }
            const otherBtns = message.querySelectorAll('.bot-action-btn:not(.regenerate)');
            otherBtns.forEach(btn => { btn.style.opacity = 1; btn.style.pointerEvents = 'auto'; });
        });
    }

    function createBotActions(content, messageIndex, feedbackStatus = null) {
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'bot-actions';
        actionsContainer.setAttribute('data-message-index', messageIndex);

        const likeBtn = createActionButton('like', 'ì¢‹ì•„ìš”', feedbackStatus, 'thumb_up');
        const dislikeBtn = createActionButton('dislike', 'ì‹«ì–´ìš”', feedbackStatus, 'thumb_down');
        const copyBtn = createActionButton('copy', 'ë³µì‚¬', null, 'content_copy');
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(content).then(() => { showSnackbar('ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); })
            .catch(err => { showSnackbar('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
        });
        const shareBtn = createActionButton('share', 'ê³µìœ ', null, 'share');
        shareBtn.addEventListener('click', () => {
            if (navigator.share) { navigator.share({ title: 'MinsuGPT ê³µìœ ', text: content, }).catch(error => console.error('ê³µìœ  ì‹¤íŒ¨', error)); } 
            else { navigator.clipboard.writeText(content).then(() => { showSnackbar('ê³µìœ  ê¸°ëŠ¥ì´ ì—†ì–´ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'); }); }
        });

        const regenerateBtn = createActionButton('regenerate', 'ë‹¤ì‹œ ë‹µë³€ë°›ê¸°', null, 'autorenew');
        regenerateBtn.addEventListener('click', (e) => { if (!regenerateBtn.classList.contains('disabled')) { handleRegenerate(messageIndex); } else { showSnackbar('ê°€ì¥ ìµœì‹  ë‹µë³€ë§Œ ì¬ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); } });

        const toggleFeedback = (action, otherAction, index) => {
            const currentMessage = history[index];
            if (!currentMessage || currentMessage.role !== 'model') return;
            const newFeedback = currentMessage.feedback === action ? null : action;
            currentMessage.feedback = newFeedback; history[index].feedback = newFeedback; 
            saveChatHistory(); 
            const btn = document.querySelector(`.bot-message[data-index="${index}"] .bot-action-btn.${action}`);
            const otherBtn = document.querySelector(`.bot-message[data-index="${index}"] .bot-action-btn.${otherAction}`);
            if (newFeedback) { btn.classList.add('selected'); if (otherBtn) otherBtn.classList.remove('selected'); } 
            else { btn.classList.remove('selected'); }
        };

        likeBtn.addEventListener('click', () => toggleFeedback('like', 'dislike', messageIndex));
        dislikeBtn.addEventListener('click', () => toggleFeedback('dislike', 'like', messageIndex));
        
        actionsContainer.appendChild(likeBtn); actionsContainer.appendChild(dislikeBtn); actionsContainer.appendChild(copyBtn); actionsContainer.appendChild(shareBtn); actionsContainer.appendChild(regenerateBtn);
        if (messageIndex !== history.length - 1 && history.filter(msg => msg.role === 'model').length > 0) { regenerateBtn.classList.add('disabled'); }
        return actionsContainer;
    }

    function handleRegenerate(messageIndex) {
        if (isStreaming || isFadingIn) { showSnackbar('í˜„ì¬ ë‹µë³€ ìƒì„± ì¤‘ì´ê±°ë‚˜ ì• ë‹ˆë©”ì´ì…˜ì´ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤.'); return; }
        const modelMessageIndex = history.findIndex((msg, index) => index === messageIndex && msg.role === 'model');
        if (modelMessageIndex === -1) { showSnackbar('ì¬ìƒì„±í•  ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

        let userMessageIndex = -1;
        for (let i = modelMessageIndex - 1; i >= 0; i--) { if (history[i].role === 'user') { userMessageIndex = i; break; } }
        if (userMessageIndex === -1) { showSnackbar('ì¬ìƒì„±í•  ì‚¬ìš©ì ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        
        const originalPrompt = history[userMessageIndex].content;
        history.splice(modelMessageIndex, history.length - modelMessageIndex);
        saveChatHistory();
        
        const botMessageElement = document.querySelector(`.bot-message[data-index="${messageIndex}"]`);
        if (botMessageElement) {
             let current = botMessageElement;
             while (current) {
                 const next = current.nextSibling;
                 if (current.classList.contains('bot-message') || current.classList.contains('stop-message')) { current.remove(); }
                 current = next;
             }
        }
        // ì¬ì„±ì„± ì‹œ ì´ë¯¸ì§€ ëª¨ë“œì¸ì§€ í…ìŠ¤íŠ¸ ëª¨ë“œì¸ì§€ í™•ì¸ í•„ìš”í•˜ë‚˜, 
        // ë³µì¡ì„±ì„ ì¤„ì´ê¸° ìœ„í•´ ì¬ìƒì„±ì€ í˜„ì¬ 'í…ìŠ¤íŠ¸' ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•œë‹¤ê³  ê°€ì •
        // (ì´ë¯¸ì§€ ì¬ìƒì„±ì€ ë‹¤ì‹œ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ëŠ” ê²ƒì´ ìì—°ìŠ¤ëŸ¬ì›€)
        currentLoadingText = 'ë‹¤ì‹œ ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...';
        autoScrollEnabled = true; scrollDownButton.classList.remove('visible');
        sendMessage(originalPrompt, true); 
    }
    
    function createActionButton(actionType, ariaLabel, feedbackStatus = null, iconName) {
        const btn = document.createElement('div');
        btn.className = `bot-action-btn ${actionType}`;
        btn.setAttribute('role', 'button'); btn.setAttribute('aria-label', ariaLabel);
        if (feedbackStatus === actionType) { btn.classList.add('selected'); }
        btn.innerHTML = `<span class="material-symbols-rounded">${iconName}</span>`;
        return btn;
    }
    
    function appendBotMessageContainer() {
        const botMessageContainer = document.createElement('div');
        botMessageContainer.className = 'bot-message';
        botMessageContainer.setAttribute('data-index', history.length); 
        
        const indicatorContainer = document.createElement('div');
        indicatorContainer.id = 'thinking-indicator'; indicatorContainer.className = 'thinking-indicator';
        
        const spinner = document.createElement('div'); spinner.className = 'loading-spinner';
        // ğŸŒŸ [ìˆ˜ì •] ì´ë¯¸ì§€ ëª¨ë“œì¼ ë•Œ ìŠ¤í”¼ë„ˆ ìƒ‰ìƒ í´ë˜ìŠ¤ ì¶”ê°€
        if (isImageMode) { spinner.classList.add('image-gen'); }

        const indicatorText = document.createElement('span'); indicatorText.className = 'thinking-indicator-text'; indicatorText.textContent = currentLoadingText; 
        
        indicatorContainer.appendChild(spinner); indicatorContainer.appendChild(indicatorText);
        
        const streamingBlock = document.createElement('div'); streamingBlock.className = 'streaming-block'; 
        
        botMessageContainer.appendChild(indicatorContainer); botMessageContainer.appendChild(streamingBlock);
        chatMessages.appendChild(botMessageContainer);
        if (autoScrollEnabled) scrollToBottom(true);
        
        return { botMessageElement: botMessageContainer, indicatorElement: indicatorContainer, streamingBlockElement: streamingBlock, spinnerElement: spinner, indicatorTextElement: indicatorText };
    }
    
    function startStreamingUI(indicator) { }

    function renderMarkdown(rawText, wrapSentences = false) {
        if (!rawText) return "";
        let html = rawText.replace(/\r/g, ''); 
        html = html.replace(/```([^`]+?)```/gs, (match, content) => { return `<pre><code>${content.trim()}</code></pre>`; });
        html = html.replace(/^(#+)\s*([^\n]+)/gm, (match, hashes, content) => { return `<h${hashes.length}>${content}</h${hashes.length}>`; });
        html = html.replace(/`([^`\n]+?)`/g, '<code>$1</code>');
        html = html.replace(/\*\*([^\*]+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/__([^__]+?)__/g, '<strong>$1</strong>');
        
        if (wrapSentences) {
            const sentenceRegex = /([^.?!]+[.?!]+(?:\s|<br>|\n|$)+)/g;
            const parts = html.split(sentenceRegex).filter(p => p.trim().length > 0 || p.match(/^[.?!]+\s*$/));
            let wrappedHtml = '';
            for (const part of parts) {
                if (part.trim().length === 0 && !part.includes('<br>') && !part.includes('\n')) continue; 
                if (part.match(/<pre>/) || part.match(/<h[1-6]>/)) { wrappedHtml += part; } 
                else { wrappedHtml += `<span class="sentence">${part.replace(/(?<!<br>)\n/g, '<br>')}</span>`; }
            }
            html = wrappedHtml;
        }
        if (!wrapSentences) { html = html.replace(/(?<!<br>)\n/g, '<br>'); }
        return html;
    }
    
    function sentenceFadeInEffect(element, rawText, messageIndex) {
        return new Promise(resolve => {
            isFadingIn = true;
            element.innerHTML = renderMarkdown(rawText, true);
            const sentences = element.querySelectorAll('.sentence');
            let index = 0;
            const delay = FADE_IN_DELAY; 
            const abortFadeIn = () => { isFadingIn = false; sentences.forEach(s => s.classList.add('visible')); if (autoScrollEnabled) scrollToBottom(true); resolve(); };
            fadeOutAbortController = { abort: abortFadeIn };

            function showNextSentence() {
                if (!isFadingIn) { return; }
                if (index < sentences.length) {
                    const currentSentence = sentences[index];
                    currentSentence.classList.add('visible');
                    if (autoScrollEnabled) {
                        const rect = currentSentence.getBoundingClientRect();
                        const wrapperRect = contentWrapper.getBoundingClientRect();
                        const composerHeight = composer.clientHeight;
                        if (rect.bottom > wrapperRect.bottom - composerHeight - 20) { scrollToBottom(true); }
                    }
                    index++; setTimeout(showNextSentence, delay);
                } else { isFadingIn = false; resolve(); }
            }
            showNextSentence();
        });
    }

    function setStreamingState(active) {
        isStreaming = active;
        if (active) {
            sendButton.style.display = 'none'; stopButton.style.display = 'flex'; inputField.setAttribute('readonly', 'true');
            autoScrollEnabled = true; scrollDownButton.classList.remove('visible');
        } else {
            sendButton.style.display = 'flex'; stopButton.style.display = 'none'; inputField.removeAttribute('readonly'); abortController = null;
        }
        toggleSendButton();
    }
    
    function stopResponse() {
        showSnackbar("ë‹µë³€ ì¤‘ì§€ë¨.");
        const lastBotMessageElement = chatMessages.lastElementChild;
        let indicatorText = null; let spinner = null; let indicatorContainer = null;
        
        if (lastBotMessageElement) {
            indicatorContainer = lastBotMessageElement.querySelector('#thinking-indicator');
            if (indicatorContainer) { spinner = indicatorContainer.querySelector('.loading-spinner'); indicatorText = indicatorContainer.querySelector('.thinking-indicator-text'); }
        }
        
        if (isFadingIn && fadeOutAbortController) {
            fadeOutAbortController.abort();
            if (indicatorText) { indicatorText.textContent = 'ë‹µë³€ ì¤‘ì§€ë¨'; indicatorText.classList.add('completed'); }
            if (indicatorContainer) indicatorContainer.classList.add('left-aligned'); 
            if (spinner) spinner.classList.add('reset-spin'); 
            
            if (lastBotMessageElement) {
                const stopText = document.createElement('div'); stopText.className = 'stop-message'; stopText.textContent = "ë‹µë³€ ì¤‘ì§€ë¨.";
                lastBotMessageElement.insertAdjacentElement('afterend', stopText);
                history.push({ role: 'model', content: fullResponse, feedback: null }); saveChatHistory();
                const actionContainer = createBotActions(fullResponse, history.length - 1);
                lastBotMessageElement.appendChild(actionContainer); updateRegenerateButtons();
            }
            setStreamingState(false); scrollToBottom(true); return;
        }
        
        if (abortController) {
            abortController.abort();
            // ... (ê¸°ì¡´ ì¤‘ì§€ ë¡œì§ ë™ì¼)
            if (lastBotMessageElement) {
                 const streamingBlock = lastBotMessageElement.querySelector('.streaming-block');
                if (fullResponse.trim().length === 0 && !streamingBlock.querySelector('img')) { // ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œë§Œ ì œê±°
                    lastBotMessageElement.remove(); 
                    if (history.length > 0 && history[history.length - 1].role === 'user') { history.pop(); saveChatHistory(); }
                } else if (streamingBlock) {
                    // ...
                } 
            }
        }
        setStreamingState(false); scrollToBottom(true);
    }
    stopButton.addEventListener('click', stopResponse);

    let fullResponse = ""; 

    async function sendMessage(userMessageOverride = null, isRegenerate = false) {
        const userMessage = userMessageOverride !== null ? userMessageOverride : inputField.value.trim();
        if (userMessage.length === 0 || isStreaming || isFadingIn) { if (isStreaming || isFadingIn) showSnackbar('í˜„ì¬ ë‹µë³€ ìƒì„± ì¤‘ì´ê±°ë‚˜ ì• ë‹ˆë©”ì´ì…˜ì´ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤.'); return; }

        if (!isRegenerate) {
            if (isImageMode) {
                 currentLoadingText = 'ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...';
            } else {
                 currentLoadingText = 'ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...';
            }

            if (initialContent.style.opacity !== '0') {
                initialContent.style.opacity = '0'; initialContent.style.visibility = 'hidden'; 
                setTimeout(() => { initialContent.style.display = 'none'; chatMessages.style.display = 'flex'; }, 500); 
            } else { chatMessages.style.display = 'flex'; }
            const existingStops = chatMessages.querySelectorAll('.stop-message'); existingStops.forEach(el => el.remove());
            updateRegenerateButtons(); 
            appendUserMessage(userMessage); history.push({ role: 'user', content: userMessage }); 
        } 
        
        if (userMessageOverride === null) { inputField.value = ''; inputField.rows = MIN_ROWS; autoResizeTextarea(); }
        
        const { botMessageElement, indicatorElement, streamingBlockElement, spinnerElement, indicatorTextElement } = appendBotMessageContainer();
        
        setStreamingState(true);
        abortController = new AbortController();
        const signal = abortController.signal;
        
        fullResponse = ""; 
        
        try {
            // ğŸŒŸ [ë¶„ê¸°] ì´ë¯¸ì§€ ìƒì„± ëª¨ë“œ vs í…ìŠ¤íŠ¸ ìƒì„± ëª¨ë“œ
            if (isImageMode) {
                // ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ (ë¹„ìŠ¤íŠ¸ë¦¬ë°)
                const response = await fetch(IMAGE_ENDPOINT, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ prompt: userMessage }), 
                    signal: signal 
                });

                if (!response.ok) { throw new Error(`HTTP ${response.status}`); }
                
                const data = await response.json();
                
                if (data.success && data.image_data) {
                    // ì„±ê³µ ì‹œ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
                    const imgHtml = `<img src="${data.image_data}" alt="Generated Image" style="max-width: 100%; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
                    fullResponse = imgHtml;
                    
                    streamingBlockElement.innerHTML = fullResponse;
                    
                    // ì™„ë£Œ ì²˜ë¦¬
                    setStreamingState(false);
                    history.push({ role: 'model', content: fullResponse, feedback: null }); saveChatHistory();
                    if (spinnerElement) spinnerElement.classList.add('reset-spin'); 
                    if (indicatorTextElement) { indicatorTextElement.textContent = 'ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ'; indicatorTextElement.classList.add('completed'); }
                    indicatorElement.classList.add('left-aligned');
                    
                    // ì´ë¯¸ì§€ ìƒì„± í›„ ëª¨ë“œ ìë™ í•´ì œ (ì„ íƒì‚¬í•­, ì—¬ê¸°ì„œëŠ” í•´ì œ)
                    toggleImageMode(false);
                    
                } else {
                    throw new Error(data.error || "ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨");
                }

            } else {
                // ğŸ“ ê¸°ì¡´ í…ìŠ¤íŠ¸ ìƒì„± ë¡œì§ (ìŠ¤íŠ¸ë¦¬ë°)
                const response = await fetch(BACKEND_ENDPOINT, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ 
                        message: userMessage, 
                        history: [PRE_PROMPT, ...history],
                    }), 
                    signal: signal 
                });

                if (!response.ok) { throw new Error(`HTTP ${response.status}`); }

                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = ""; let isFirstChunk = true; 

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break; 
                    buffer += decoder.decode(value, { stream: true });
                    const parts = buffer.split('\n');
                    buffer = parts.pop(); 

                    for (const part of parts) {
                        const cleanPart = part; 
                        if (cleanPart.trim() === "[DONE]") {
                            fullResponse += buffer;
                            setStreamingState(false);
                            history.push({ role: 'model', content: fullResponse, feedback: null }); saveChatHistory();
                            if (spinnerElement) spinnerElement.classList.add('reset-spin'); 
                            if (indicatorTextElement) { indicatorTextElement.textContent = 'ë‹µë³€ ì™„ë£Œë¨'; indicatorTextElement.classList.add('completed'); }
                            indicatorElement.classList.add('left-aligned'); 
                            sentenceFadeInEffect(streamingBlockElement, fullResponse, history.length - 1).then(() => {
                                const actionContainer = createBotActions(fullResponse, history.length - 1);
                                botMessageElement.appendChild(actionContainer); updateRegenerateButtons();
                                if (autoScrollEnabled) scrollToBottom(true);
                            });
                            reader.releaseLock(); return; 
                        }
                        
                        if (cleanPart.length > 0) {
                            if (isFirstChunk) { startStreamingUI(indicatorElement); isFirstChunk = false; }
                            fullResponse += cleanPart + '\n'; 
                            streamingBlockElement.innerHTML = renderMarkdown(fullResponse);
                            if (autoScrollEnabled) scrollToBottom(false);
                        }
                    }
                }
                // (buffer ì²˜ë¦¬ ë“± ê¸°ì¡´ ë¡œì§ ìœ ì§€...)
            }
        } catch (error) {
            if (error.name === 'AbortError') { console.log('Fetch aborted'); } 
            else {
                const errorMsg = `âš ï¸ ì˜¤ë¥˜: ${error.message}`;
                startStreamingUI(indicatorElement); streamingBlockElement.innerHTML = `<p style="color:red;">${errorMsg}</p>`;
                if (spinnerElement) spinnerElement.classList.add('reset-spin');
                if (indicatorTextElement) { indicatorTextElement.textContent = 'ì‘ë‹µ ì˜¤ë¥˜'; indicatorTextElement.classList.add('completed'); }
                if (history.length > 0 && history[history.length - 1].role === 'user') { history.pop(); saveChatHistory(); }
                updateRegenerateButtons();
            }
            setStreamingState(false); scrollToBottom(true); 
        }
        if(isStreaming) setStreamingState(false);
    }

    sendButton.addEventListener('click', () => sendMessage());

    quickActionButtons.forEach(button => {
        button.addEventListener('click', () => {
            const prompt = button.getAttribute('data-prompt');
            if (prompt) {
                inputField.value = prompt; autoResizeTextarea();
                autoScrollEnabled = true; scrollDownButton.classList.remove('visible');
                sendMessage(null, false); 
            }
        });
    });

    inputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            if (!isMobile()) {
                if (e.shiftKey) { setTimeout(autoResizeTextarea, 0); return; }
                e.preventDefault(); 
                if (sendButton.classList.contains('active') && !isStreaming) {
                    autoScrollEnabled = true; scrollDownButton.classList.remove('visible'); sendMessage();
                }
            }
        }
    });

    function togglePlusModal(show) {
        if (show === undefined) { plusModalBackdrop.classList.toggle('visible'); } 
        else if (show) { plusModalBackdrop.classList.add('visible'); } 
        else { plusModalBackdrop.classList.remove('visible'); }
    }
    plusButton.addEventListener('click', (e) => { e.preventDefault(); togglePlusModal(); });
    plusModalBackdrop.addEventListener('click', (e) => { if (e.target === plusModalBackdrop) togglePlusModal(false); });
    
    function toggleSettingsModal(show) {
        if (show === undefined) { settingsModalBackdrop.classList.toggle('visible'); } 
        else if (show) { settingsModalBackdrop.classList.add('visible'); } 
        else { settingsModalBackdrop.classList.remove('visible'); }
    }
    settingsButton.addEventListener('click', (e) => { e.preventDefault(); toggleSettingsModal(); });
    settingsModalBackdrop.addEventListener('click', (e) => { if (e.target === settingsModalBackdrop) toggleSettingsModal(false); });
    
    const toolAttach = document.getElementById('tool-attach');
    if(toolAttach) { toolAttach.addEventListener('click', (e) => { e.preventDefault(); togglePlusModal(true); }); }
    
    // í•™ìŠµí•˜ê¸° ë²„íŠ¼
    if(toolStudy) { toolStudy.addEventListener('click', () => { toolStudy.classList.toggle('active-blue'); }); }

    window.onload = function() {
        loadTheme();
        loadUIStyle(); 
        loadChatHistory();
        toggleSendButton();
        autoResizeTextarea();
    };
  </script>
</body>
  </html>
