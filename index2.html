<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    :root {
        /* 디자인 변수 */
        --radius-input: 26px;      
        --radius-send-btn: 12px;   
        --radius-window: 16px;     
        --radius-icon-btn: 50%;    
        --radius-bubble: 20px;     
        
        /* 3. 호버 배경 곡률 조정 (여기 숫자를 바꾸세요!) */
        --model-hover-radius: 12px; 
        
        --line-height: 24px;
        --primary-color: #4F46E5; 
        
        --user-bubble-bg: #F4F4F5; 
        --user-bubble-text: #1F2937;
        --top-bar-height: 50px;

        /* 폰트 설정: 영문은 Mulish, 한글은 시스템 폰트 */
        --main-font: "Mulish", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
        background-color: #fff;
        margin: 0;
        /* Mulish 폰트 적용 */
        font-family: var(--main-font);
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    .material-symbols-rounded {
        font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24;
        font-size: 24px;
        display: block;
        user-select: none;
    }

    /* ---------------------------------------------------------
       상단바 (Top Bar)
    --------------------------------------------------------- */
    .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--top-bar-height);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 16px;
        box-sizing: border-box;
        background-color: #fff; 
        z-index: 1000;
        font-size: 18px;
        font-weight: 700; /* Mulish 굵게 */
        color: #333;
    }

    .top-bar-left {
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        padding: 6px 10px;
        
        /* 사용자 정의 곡률 적용 */
        border-radius: var(--model-hover-radius);
        
        transition: background 0.2s;
    }
    .top-bar-left:hover {
        background-color: #F3F4F6;
    }
    .model-name {
        color: #4B5563;
        font-size: 17px;
        letter-spacing: -0.02em;
    }

    .top-bar-right {
        display: flex;
        align-items: center;
    }

    /* 2. 토글 버튼 (아이콘만 표시) */
    .toggle-icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%; /* 버튼 자체는 원형 */
        color: #6B7280;
        transition: background-color 0.2s, color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .toggle-icon-btn:hover {
        background-color: #F3F4F6;
        color: #374151;
    }
    
    /* 비공개 모드 활성화 시 (아이콘 색상 변경 등 필요하면 추가) */
    .toggle-icon-btn.active {
        color: #374151; 
    }

    /* ---------------------------------------------------------
       채팅 영역
    --------------------------------------------------------- */
    .chat-container {
        flex: 1;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        padding-top: calc(var(--top-bar-height) + 20px); 
        padding-bottom: 160px;
        box-sizing: border-box;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .message-wrapper {
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .message-row {
        display: flex;
        width: 100%;
    }

    .message-row.user {
        justify-content: flex-end;
    }

    .message-row.bot {
        justify-content: flex-start;
    }

    /* 내 메시지 스타일 */
    .user-bubble {
        background-color: var(--user-bubble-bg);
        color: var(--user-bubble-text);          
        padding: 10px 16px;
        border-radius: var(--radius-bubble);
        max-width: 70%;
        word-break: break-word;
        font-size: 15px;
        line-height: 1.5;
    }

    /* 봇 메시지 스타일 */
    .bot-text {
        color: #1F2937;
        padding: 8px 0;
        width: 100%; 
        max-width: 100%;
        font-size: 16px;
        line-height: 1.7;
        word-break: break-word;
    }

    .bot-text p { margin: 0 0 10px 0; }
    .bot-text p:last-child { margin-bottom: 0; }
    .bot-text pre {
        background-color: #1e1e1e;
        color: #dcdcdc;
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 14px;
        margin: 10px 0;
    }
    .bot-text code {
        background-color: #F3F4F6;
        color: #c7254e;
        padding: 2px 4px;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 90%;
    }
    .bot-text pre code {
        background-color: transparent;
        color: inherit;
        padding: 0;
    }

    /* 복사 버튼 */
    .copy-container {
        display: flex;
        justify-content: flex-start;
        margin-top: 6px;
        opacity: 0;
        transform: translateY(-5px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        padding-left: 2px;
    }
    .copy-container.visible {
        opacity: 1;
        transform: translateY(0);
    }
    .copy-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #9CA3AF;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 6px;
        font-family: var(--main-font); /* 버튼 폰트도 통일 */
        transition: background 0.2s, color 0.2s;
    }
    .copy-btn:hover {
        background-color: #F3F4F6;
        color: #4B5563;
    }
    .copy-btn .material-symbols-rounded { font-size: 16px; }

    /* 분석 중 텍스트 효과 */
    @keyframes textShimmer {
        0% { background-position: 200% 0; }   
        100% { background-position: -200% 0; }
    }
    .analyzing-text {
        font-size: 16px;
        font-weight: 500;
        padding: 8px 0;
        cursor: default; 
        color: #1F2937;
        background: linear-gradient(110deg, #1F2937 40%, #ffffff 50%, #1F2937 60%);
        background-size: 200% 100%;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent; 
        animation: textShimmer 2s linear infinite;
    }

    /* 하단 입력창 고정 영역 */
    .bottom-fixed-wrapper {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 20px; 
        padding-bottom: 20px;
        box-sizing: border-box;
        background: linear-gradient(to top, #ffffff 90%, rgba(255,255,255,0));
        z-index: 1000;
        pointer-events: none;
    }

    .chat-input-container {
        pointer-events: auto;
        width: 100%;
        max-width: 800px;
        background-color: #F4F4F5;
        border-radius: var(--radius-input);
        padding: 12px 16px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        position: relative; 
        transition: height 0.1s ease;
        box-shadow: none !important;
    }

    .chat-textarea {
        width: 100%;
        border: none;
        background: transparent;
        resize: none;
        outline: none;
        font-size: 16px;
        color: #333;
        font-family: var(--main-font); /* 입력창 폰트도 통일 */
        padding: 0;
        line-height: var(--line-height);
        height: var(--line-height);
        max-height: calc(var(--line-height) * 4);
        overflow-y: hidden; 
        scrollbar-width: none;
    }
    .chat-textarea::-webkit-scrollbar { display: none; }
    .chat-textarea::placeholder { color: #9CA3AF; }

    .input-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 6px; 
    }

    .left-tools { display: flex; gap: 8px; }

    .icon-btn {
        background: none;
        border: none;
        border-radius: var(--radius-icon-btn);
        padding: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6B7280;
        transition: background-color 0.2s, color 0.2s;
    }
    .icon-btn:hover {
        background-color: rgba(0,0,0,0.05);
        color: #374151;
    }

    #searchBtn.active {
        color: #0EA5E9; 
        background-color: rgba(14, 165, 233, 0.1); 
    }
    #attachBtn .material-symbols-rounded { transform: rotate(45deg); }

    .send-btn {
        background-color: #E5E7EB; 
        border: none;
        border-radius: var(--radius-send-btn);
        width: 32px;
        height: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: default;
        transition: all 0.2s ease-in-out;
    }
    .send-btn .material-symbols-rounded { font-size: 20px; color: #9CA3AF; }
    .send-btn:not(:disabled) { background-color: var(--primary-color); cursor: pointer; }
    .send-btn:not(:disabled) .material-symbols-rounded { color: #ffffff; }
    .send-btn:not(:disabled):hover { background-color: #4338ca; }

    .disclaimer-text {
        font-size: 12px;
        color: #6B7280;
        margin-top: 12px;
        text-align: center;
        pointer-events: auto; 
    }

    .attach-menu {
        display: none; 
        position: absolute;
        bottom: 55px;
        left: 0;
        width: 140px;
        background-color: #FFFFFF; 
        border: 1px solid #E5E7EB; 
        border-radius: var(--radius-window);
        padding: 6px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); 
        z-index: 2000;
        flex-direction: column;
        gap: 2px;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .attach-menu.open { display: flex; opacity: 1; transform: translateY(0); }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        color: #374151; 
        font-size: 14px;
        border-radius: 8px; 
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        font-weight: 500;
    }
    .menu-item:hover { background-color: #F3F4F6; }
    .menu-item .material-symbols-rounded { font-size: 20px; color: #4B5563; }

</style>
</head>
<body>

    <div class="top-bar">
        <div class="top-bar-left">
            <span class="model-name">MinsuGPT</span>
            <span class="material-symbols-rounded" style="font-size: 20px; color: #9CA3AF;">keyboard_arrow_down</span>
        </div>
        
        <div class="top-bar-right">
            <button id="privateToggleBtn" class="toggle-icon-btn" title="대화 저장 모드 변경">
                <svg id="toggleSvg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" />
                </svg>
            </button>
        </div>
    </div>

    <div id="chatContainer" class="chat-container">
        </div>

    <div class="bottom-fixed-wrapper">
        <div class="chat-input-container">
            
            <div id="attachMenu" class="attach-menu">
                <div class="menu-item">
                    <span class="material-symbols-rounded">image</span> <span>이미지</span>
                </div>
                <div class="menu-item">
                    <span class="material-symbols-rounded">description</span> <span>문서</span>
                </div>
                <div class="menu-item">
                    <span class="material-symbols-rounded">folder</span> <span>파일</span>
                </div>
            </div>

            <textarea id="chatInput" class="chat-textarea" placeholder="메시지를 입력해주세요." rows="1"></textarea>
            
            <div class="input-toolbar">
                <div class="left-tools">
                    <button id="attachBtn" class="icon-btn" title="첨부하기">
                        <span class="material-symbols-rounded">attach_file</span>
                    </button>
                    <button id="searchBtn" class="icon-btn" title="검색 모드">
                        <span class="material-symbols-rounded">language</span>
                    </button>
                </div>

                <button id="sendBtn" class="send-btn" disabled>
                    <span class="material-symbols-rounded">arrow_upward</span>
                </button>
            </div>
        </div>

        <div class="disclaimer-text">
            MinsuGPT는 실수할 수 있습니다. 중요한 정보는 한번더 확인하세요.
        </div>
    </div>

    <script>
        marked.setOptions({ breaks: true, gfm: true });

        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const attachBtn = document.getElementById('attachBtn');
        const attachMenu = document.getElementById('attachMenu');
        const searchBtn = document.getElementById('searchBtn');
        
        const privateToggleBtn = document.getElementById('privateToggleBtn');
        const toggleSvg = document.getElementById('toggleSvg');

        let chatHistory = [];
        let isPrivateMode = false;

        // SVG Path 데이터
        // 1. 꽉 찬 말풍선 (공개/저장)
        const PATH_FILLED = "M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z";
        
        // 2. 점선/테두리 말풍선 (비공개/임시) - 직접 그린 점선 스타일
        // stroke-dasharray를 사용하여 점선 효과를 줍니다.
        // SVG 속성을 JS로 조작합니다.

        privateToggleBtn.addEventListener('click', () => {
            isPrivateMode = !isPrivateMode;
            
            // 기존 내용 지우고 새로 그리기
            toggleSvg.innerHTML = '';
            
            if (isPrivateMode) {
                // [비공개 모드] -> 점선 테두리 아이콘 (임시 채팅 느낌)
                privateToggleBtn.classList.add('active');
                privateToggleBtn.title = "비공개 채팅 (기록 안 남음)";
                
                // SVG 속성 변경: 채우기 없음, 선 있음, 점선
                toggleSvg.setAttribute('fill', 'none');
                toggleSvg.setAttribute('stroke', 'currentColor');
                toggleSvg.setAttribute('stroke-width', '2');
                toggleSvg.setAttribute('stroke-dasharray', '4 2'); // 점선 효과
                
                // 외곽선 경로 추가
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", "M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z");
                toggleSvg.appendChild(path);

            } else {
                // [공개 모드] -> 꽉 찬 아이콘 (기록 저장됨)
                privateToggleBtn.classList.remove('active');
                privateToggleBtn.title = "공개 채팅 (기록 저장됨)";

                // SVG 속성 리셋
                toggleSvg.setAttribute('fill', 'currentColor');
                toggleSvg.removeAttribute('stroke');
                toggleSvg.removeAttribute('stroke-width');
                toggleSvg.removeAttribute('stroke-dasharray');

                // 꽉 찬 경로 추가
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", PATH_FILLED);
                toggleSvg.appendChild(path);
            }
        });

        function adjustHeight() {
            chatInput.style.height = 'auto'; 
            let scrollHeight = chatInput.scrollHeight;
            if (scrollHeight > 96) {
                chatInput.style.height = '96px';
                chatInput.style.overflowY = 'scroll'; 
            } else {
                chatInput.style.height = scrollHeight + 'px';
                chatInput.style.overflowY = 'hidden'; 
            }
            sendBtn.disabled = chatInput.value.trim().length === 0;
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (text.length === 0) return;

            addMessage(text, 'user');

            if (!isPrivateMode) {
                chatHistory.push({ "role": "user", "content": text });
            }
            
            chatInput.value = '';
            adjustHeight();
            sendBtn.disabled = true;

            const loadingId = 'loading-' + Date.now();
            addLoadingMessage(loadingId);

            const isSearchMode = searchBtn.classList.contains('active');
            const endpoint = isSearchMode ? '/ask' : '/askfast';
            const backendUrl = 'https://jaewondev.pythonanywhere.com' + endpoint;

            try {
                const historyToSend = isPrivateMode ? [] : chatHistory;

                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: text,
                        history: historyToSend,
                        image_base64: [] 
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                
                let isFirstChunk = true;
                let botContentDiv = null; 
                let messageWrapper = null; 
                let fullBotResponse = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    let chunk = decoder.decode(value, { stream: true });
                    chunk = chunk.replace("[DONE]", ""); 

                    if (chunk) {
                        if (isFirstChunk) {
                            removeLoadingMessage(loadingId);
                            const createdElements = createBotBubble(); 
                            messageWrapper = createdElements.wrapper;
                            botContentDiv = createdElements.content;
                            isFirstChunk = false;
                        }
                        fullBotResponse += chunk;
                        botContentDiv.innerHTML = marked.parse(fullBotResponse);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                }

                if (!isPrivateMode) {
                    chatHistory.push({ "role": "model", "content": fullBotResponse });
                }

                if (messageWrapper && fullBotResponse) {
                    addCopyButton(messageWrapper, fullBotResponse);
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                removeLoadingMessage(loadingId);
                addMessage("죄송합니다. 오류가 발생했습니다: " + error.message, 'bot');
            }
        }

        function addLoadingMessage(id) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('message-row', 'bot');
            rowDiv.id = id; 
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('analyzing-text'); 
            contentDiv.innerText = "답변 생성중...";
            rowDiv.appendChild(contentDiv);
            chatContainer.appendChild(rowDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoadingMessage(id) {
            const loadingElem = document.getElementById(id);
            if (loadingElem) loadingElem.remove();
        }

        function addMessage(text, sender) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('message-row', sender); 

            const contentDiv = document.createElement('div');
            if (sender === 'user') {
                contentDiv.classList.add('user-bubble');
                contentDiv.innerText = text; 
            } else {
                contentDiv.classList.add('bot-text'); 
                contentDiv.innerHTML = marked.parse(text); 
            }

            rowDiv.appendChild(contentDiv);
            chatContainer.appendChild(rowDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function createBotBubble() {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('message-row', 'bot');
            const wrapperDiv = document.createElement('div');
            wrapperDiv.classList.add('message-wrapper');
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('bot-text'); 
            
            wrapperDiv.appendChild(contentDiv);
            rowDiv.appendChild(wrapperDiv);
            chatContainer.appendChild(rowDiv);
            return { wrapper: wrapperDiv, content: contentDiv };
        }

        function addCopyButton(wrapperElement, textToCopy) {
            const copyContainer = document.createElement('div');
            copyContainer.classList.add('copy-container');
            const copyBtn = document.createElement('button');
            copyBtn.classList.add('copy-btn');
            copyBtn.innerHTML = `<span class="material-symbols-rounded">content_copy</span> 복사하기`;
            
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyBtn.innerHTML = `<span class="material-symbols-rounded">check</span> 복사됨`;
                    setTimeout(() => {
                        copyBtn.innerHTML = `<span class="material-symbols-rounded">content_copy</span> 복사하기`;
                    }, 2000);
                });
            });

            copyContainer.appendChild(copyBtn);
            wrapperElement.appendChild(copyContainer);
            setTimeout(() => { copyContainer.classList.add('visible'); }, 100);
        }

        chatInput.addEventListener('input', adjustHeight);
        chatInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const isMobile = window.innerWidth <= 768;
                if (!isMobile && !event.shiftKey) {
                    event.preventDefault(); 
                    if (!sendBtn.disabled) sendMessage();
                }
            }
        });
        sendBtn.addEventListener('click', sendMessage);
        attachBtn.addEventListener('click', function(e) {
            e.stopPropagation(); 
            if (attachMenu.classList.contains('open')) {
                attachMenu.classList.remove('open');
                setTimeout(() => { attachMenu.style.display = 'none'; }, 200);
            } else {
                attachMenu.style.display = 'flex';
                setTimeout(() => { attachMenu.classList.add('open'); }, 10);
            }
        });
        searchBtn.addEventListener('click', function() {
            this.classList.toggle('active');
        });
        document.addEventListener('click', function(e) {
            if (attachMenu.classList.contains('open') && !attachMenu.contains(e.target)) {
                attachMenu.classList.remove('open');
                setTimeout(() => { attachMenu.style.display = 'none'; }, 200);
            }
        });
    </script>
</body>
</html>
