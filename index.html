<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MinsuGPT</title> 
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Elms+Sans:ital,wght@0,100..900;1,100..900;0,100..900;1,100..900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #ffffff;
      --accent:#111827; /* ê²€ì€ìƒ‰ ê³„ì—´ */
      --send-button-disabled: #9ca3af;
      --send-button-enabled: #111827; 
      --composer-padding: 6px 12px;
      --composer-padding-v: 12px; 
      --input-container-padding-v: 8px; 
      --font-size: 16px;
      --line-height: 1.4;
      
      /* í…ìŠ¤íŠ¸ í•œ ì¤„ì˜ ì‹¤ì œ ë†’ì´: 16px * 1.4 = 22.4px */
      --line-height-px: 22.4; 
      --min-textarea-height: 22.4px; 
      
      /* input-container ìµœì†Œ ë†’ì´: 48px */
      --min-input-container-height: 48px; 
      
      /* í°íŠ¸ ë³€ê²½: Elms Sans ì ìš© */
      font-family: 'Elms Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', 'Helvetica Neue', Arial, sans-serif;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--accent);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:0;
    }
    .phone{
      width:100%;
      background:var(--bg);
      border-radius:0;
      overflow:hidden;
      border:none;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      position:relative; 
      margin: 0;
    }

    /* ğŸŒŸğŸŒŸğŸŒŸ í—¤ë” ê³ ì • (Sticky) ì ìš© ğŸŒŸğŸŒŸğŸŒŸ */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 16px;
      height:56px;
      border-bottom:none;
      
      /* ê³ ì • ì†ì„± */
      position: sticky;
      top: 0;
      z-index: 10; /* ë‹¤ë¥¸ ì½˜í…ì¸  ìœ„ì— í‘œì‹œ */
      background: var(--bg); /* ë°°ê²½ìƒ‰ ì§€ì • (ìŠ¤í¬ë¡¤ ì‹œ ë‚´ìš©ì´ ë¹„ì¹˜ì§€ ì•Šë„ë¡) */
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* ì•½ê°„ì˜ ê·¸ë¦¼ì ì¶”ê°€ */
    }
    .header-icon{
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
    }
    .plus-btn{
      background-color:#f1f4ff;
      color:#1d6fef;
      font-weight:600;
      padding:6px 14px;
      border-radius:20px;
      display:flex;
      align-items:center;
      gap:4px;
      font-size:14px;
    }
    .plus-btn svg{
      width:16px;
      height:16px;
      fill:currentColor;
      transform:translateY(1px);
    }
    .profile-btn{
      width:32px;
      height:32px;
      border-radius:50%;
      background-color:#e5e8eb;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
    }

    .content-wrapper{
        flex-grow:1;
        display:flex;
        flex-direction:column;
        overflow-y: auto;
        padding-bottom: 0; 
        position: relative;
    }
    
    #initial-content{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 400px;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      padding: 0 16px;
      transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
    }
    .main-question{
      font-size:22px;
      font-weight:600;
      margin-bottom:40px;
      color:#111827;
    }
    .quick-actions{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:8px;
      max-width:400px; 
    }
    .action-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      border:1px solid #e5e8eb;
      border-radius:30px;
      font-size:15px;
      font-weight:500;
      color:#111827;
      min-height:48px;
      white-space:nowrap;
    }
    .action-btn svg, .action-btn .icon-light{
      margin-right:6px;
      width:20px;
      height:20px;
    }
    .action-btn.new-green svg{ stroke:#28a745; }
    .action-btn.new-blue svg{ stroke:#007bff; }
    .action-btn.orange svg{ stroke:#fd7e14; } 

    .chat-messages{
      width: 100%;
      padding: 10px 16px;
      display: none;
      flex-direction: column;
      justify-content: flex-start; 
      gap: 10px;
      margin: 0 auto; 
    }
    /* PC í™˜ê²½ì—ì„œ ì±„íŒ… ë©”ì‹œì§€ ë„ˆë¹„ ì¡°ì • (ì…ë ¥ì°½ ë„ˆë¹„ì™€ ë™ì¼í•˜ê²Œ) */
    @media (min-width: 600px) {
        .chat-messages {
            max-width: 768px; /* composer-innerì™€ ë™ì¼ */
            padding-left: 0;
            padding-right: 0;
        }
    }

    .message-bubble{
      display: flex;
      max-width: 80%;
    }
    .message-text{
      padding: 10px 14px;
      border-radius: 20px;
      line-height: 1.4;
      font-size: 15px;
      white-space: pre-wrap;
    }
    .user-message{
      justify-content: flex-end;
      align-self: flex-end;
    }
    /* ğŸŒŸğŸŒŸğŸŒŸ ì‚¬ìš©ì ë©”ì‹œì§€ ìƒ‰ìƒ ë³€ê²½ (ì—°í•œ íšŒìƒ‰) ğŸŒŸğŸŒŸğŸŒŸ */
    .user-message .message-text{
      background-color: #f1f4f9; /* ì—°í•œ íšŒìƒ‰ */
      color: var(--accent); /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²€ì€ìƒ‰ */
      border-bottom-right-radius: 4px;
    }
    
    /* ë´‡ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .bot-message{
      align-self: flex-start;
      margin-top: 10px;
      padding: 0; 
      color: var(--accent);
      line-height: 1.4;
      font-size: 15px;
      width: 100%; 
    }
    
    /* ë´‡ ë©”ì‹œì§€ ë‚´ë¶€ ìš”ì†Œ (ì „ì²´ ì»¨í…Œì´ë„ˆ) */
    .bot-message .message-blocks, .bot-message .streaming-block {
        display: block;
        padding: 0; 
        border-radius: 0; 
        background-color: transparent; 
        max-width: 100%;
        box-sizing: border-box;
        white-space: normal;
        /* ğŸŒŸğŸŒŸğŸŒŸ í…ìŠ¤íŠ¸ê°€ ì•ˆë³´ì´ëŠ” í˜„ìƒ ë°©ì§€: ê¸°ë³¸ ìƒ‰ìƒ ëª…ì‹œ ğŸŒŸğŸŒŸğŸŒŸ */
        color: var(--accent); 
    }

    /* ğŸŒŸğŸŒŸğŸŒŸ ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œì¸ ì• ë‹ˆë©”ì´ì…˜ ğŸŒŸğŸŒŸğŸŒŸ */
    .new-block-fade {
        /* opacityëŠ” JSì—ì„œ visible í´ë˜ìŠ¤ ì¶”ê°€ ì‹œ 1ë¡œ ë³€í™˜ë¨ */
        opacity: 0; 
        transform: translateY(10px);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    .new-block-fade.visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    /* ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ ë¸”ë¡ì€ ì¦‰ì‹œ í‘œì‹œ */
    .bot-message .streaming-block {
        opacity: 1; 
        transform: translateY(0);
        transition: none; /* ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
    }

    
    /* ë´‡ ë©”ì‹œì§€ ë¸”ë¡ ìŠ¤íƒ€ì¼ */
    .bot-message-block {
        padding: 0;
        margin-top: 5px; 
    }

    /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
    .bot-message h1, .bot-message h2, .bot-message h3 {
        font-weight: 700;
        margin: 1.5em 0 0.8em 0; 
        line-height: 1.3;
        clear: both;
    }
    .bot-message h1 { font-size: 1.8em; } 
    .bot-message h2 { font-size: 1.5em; } 
    .bot-message h3 { font-size: 1.25em; } 

    .bot-message strong, .bot-message b {
        font-weight: 700; 
    }

    /* ì½”ë“œ ë° ìŠ¤í¬ë¦½íŠ¸ ìŠ¤íƒ€ì¼ */
    .bot-message pre {
        background-color: #f3f4f6; 
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 0.9em;
        margin: 8px 0;
        white-space: pre-wrap;
    }
    .bot-message code {
        font-family: monospace;
    }
    .bot-message .streaming-block code, .bot-message .message-blocks code {
        background-color: #e5e7eb;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: normal;
    }
    
    /* ë‹¨ë½ ì²˜ë¦¬ */
    .bot-message p {
        margin: 0.5em 0; 
    }
    /* --------------------------------- */

    /* ğŸ’¡ ìƒê°í•˜ëŠ” ì¤‘... ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .thinking-indicator-text {
        font-weight: 500;
        padding: 10px 0; 
        
        background-color: var(--accent); 
        background-image: linear-gradient(
            90deg,
            #111827 0%,
            #ffffff 20%, 
            #111827 40%
        );
        background-size: 200% 100%; 
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 1.5s infinite linear;
    }

    /* ğŸŒŸ ì• ë‹ˆë©”ì´ì…˜ ë°©í–¥: ì™¼ìª½ìœ¼ë¡œ ì´ë™ ğŸŒŸ */
    @keyframes shimmer {
        0% {
            background-position: 100% 0; 
        }
        100% {
            background-position: -100% 0; 
        }
    }

    /* Input area */
    .composer{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      width:100%;
      display:flex;
      justify-content:center;
      padding:var(--composer-padding);
      background:var(--bg);
      box-shadow:none; 
      height: auto;
      min-height: calc(var(--min-input-container-height) + var(--composer-padding-v)); 
      z-index: 10; /* í—¤ë”ì™€ ë™ì¼í•˜ê²Œ ìƒë‹¨ì— ìœ„ì¹˜ */
    }
    .composer-inner{
      display:flex;
      align-items:center; 
      gap:8px;
      width:100%;
    }
    @media (min-width: 600px) {
        .composer-inner {
            max-width: 768px; 
        }
    }

    .input-container{
      flex:1;
      display:flex;
      align-items: center; 
      gap:8px;
      border-radius:24px;
      border:1px solid #d1d5db;
      padding:4px 4px 4px 16px;
      box-sizing:border-box;
      background:#ffffff;
      max-height: 150px; 
      overflow: hidden; 
      min-height: var(--min-input-container-height); 
    }
    /* textarea ìŠ¤íƒ€ì¼ */
    .input-container textarea{
      flex:1;
      border:0;
      outline:0;
      background:transparent;
      color:var(--accent);
      font-size:var(--font-size);
      min-width:0;
      resize: none; 
      min-height: var(--min-textarea-height); 
      overflow-y: hidden; 
      padding: 0; 
      line-height: var(--line-height);
      vertical-align: middle; 
      align-self: center; 
      font-family: inherit; 
    }
    .input-container textarea::placeholder{
        color:#9ca3af;
        font-family: inherit;
    }

    /* íŒŒì¼ ì²¨ë¶€ ë²„íŠ¼ (SVG ì ìš©) */
    .plus{
      width: var(--min-input-container-height); 
      height: var(--min-input-container-height); 
      border-radius:50%;
      background:#ffffff;
      border:1px solid #d1d5db;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      align-self: center; 
      cursor: pointer;
    }
    .plus svg {
      width: 24px; 
      height: 24px;
      fill: #111827;
    }

    .mic-voice-container{
        display:flex;
        gap:8px;
        flex-shrink:0;
        margin-bottom: 0;
    }
    .mic-icon{
        width:38px;
        height:38px;
        display:flex;
        align-items:center;
        justify-content:center;
        flex-shrink:0;
        color:#9ca3af;
    }
    .send-btn, .stop-btn{
      width:38px;
      height:38px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      margin-left:0;
      margin-right:4px;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }
    /* ì „ì†¡ ë²„íŠ¼ (í™œì„±í™”/ë¹„í™œì„±í™”) */
    .send-btn:not(.active) {
        background-color: var(--send-button-disabled);
        pointer-events: none;
    }
    .send-btn.active {
        background-color: var(--send-button-enabled); 
        pointer-events: auto;
    }
    .send-btn svg path {
        stroke-width: 2.5;
    }
    /* ì¤‘ì§€ ë²„íŠ¼ (ì‘ë‹µ ì¤‘ì¼ ë•Œë§Œ í‘œì‹œë¨) */
    .stop-btn {
        background-color: #ef4444; 
    }
  </style>
</head>
<body>
  <div class="phone" role="application" aria-label="ì±„íŒ… UI">
    <header class="header">
        <div class="header-icon menu-icon">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                <path d="M4 6h16M4 12h16M4 18h16" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="plus-btn">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-1 14h2v-4h4V10h-4V6h-2v4H7v2h4v4z" fill="currentColor" />
            </svg>
            Ultra ì´ìš©í•˜ê¸°
        </div>
        <div class="header-icon profile-btn">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                <path d="M12 2a5 5 0 0 0-5 5v1a3 3 0 0 0-3 3v4a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-4a3 3 0 0 0-3-3V7a5 5 0 0 0-5-5zM9 7a3 3 0 0 1 6 0v1H9V7z" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="17" r="2" fill="#111827"/>
            </svg>
        </div>
    </header>

    <main class="content-wrapper">
        <div id="initial-content">
            <div class="main-question">ì•ˆë…•í•˜ì„¸ìš”! ë°˜ê°€ì›Œìš”</div>
            <div class="quick-actions">
                <div class="action-btn new-green">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z" stroke="#28a745" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ëŒ€í™”í•˜ê¸°
                </div>
                <div class="action-btn">
                    <div class="icon-light">ğŸ’¡</div>
                    ë¸Œë ˆì¸ìŠ¤í† ë°
                </div>
                <div class="action-btn new-blue">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                        <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    ê¸€ ì“°ê¸°
                </div>
                <div class="action-btn orange">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                        <path d="M4 19.5V21a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1.5M4 4.5V3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v1.5M6 10h12M6 14h8" stroke="#fd7e14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    í…ìŠ¤íŠ¸ ìš”ì•½
                </div>
                <div class="action-btn">
                    <div style="font-size:18px;">...</div>
                    ë” ë³´ê¸°
                </div>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages">
            </div>
    </main>

    <div id="composer" class="composer">
      <div class="composer-inner">
        <div class="plus" aria-label="íŒŒì¼ ì²¨ë¶€">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                <path d="M12 4V20M4 12H20" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>

        <div id="input-container" class="input-container">
          <textarea id="message-input" placeholder="Minsu GPT" rows="1"></textarea>
          
          <div class="mic-voice-container">
            <div id="mic-icon" class="mic-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="22" height="22">
                    <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 11v1a7 7 0 0 1-14 0v-1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            
            <div id="action-button-container">
                <div id="send-button" class="send-btn">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                    <path d="M5 12h14M13 6l6 6-6 6" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div id="stop-button" class="stop-btn" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                        <rect x="6" y="6" width="12" height="12" rx="2" fill="white"/>
                        <rect x="6" y="6" width="12" height="12" rx="2" stroke="white" stroke-width="2"/>
                    </svg>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------------------------
    // |         ì›¹í˜ì´ì§€ ë³µì œ ë°©ì§€ ê¸°ëŠ¥ ì‹œì‘         |
    // ----------------------------------------------
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault(); 
    });

    document.onkeydown = function(e) {
      if (e.keyCode == 123) { e.preventDefault(); return false; } 
      if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) { e.preventDefault(); return false; } 
      if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { e.preventDefault(); return false; } 
    };
    // ----------------------------------------------
    // |         ì›¹í˜ì´ì§€ ë³µì œ ë°©ì§€ ê¸°ëŠ¥ ë           |
    // ----------------------------------------------

    const inputField = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const initialContent = document.getElementById('initial-content');
    const chatMessages = document.getElementById('chat-messages');
    const composer = document.getElementById('composer');
    const inputContainer = document.getElementById('input-container');

    // ğŸŒŸğŸŒŸğŸŒŸ ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (ì‚¬ìš©ì ì£¼ì†Œ ë°˜ì˜) ğŸŒŸğŸŒŸğŸŒŸ
    const BACKEND_ENDPOINT = "https://jaewondev.pythonanywhere.com/ask"; 

    // ğŸŒŸğŸŒŸğŸŒŸ ëŒ€í™” ê¸°ë¡ì„ ì €ì¥í•  ë°°ì—´ ğŸŒŸğŸŒŸğŸŒŸ
    let history = []; 

    const MAX_ROWS = 6;
    const MIN_ROWS = 1;
    const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth <= 768;
    let isStreaming = false; 
    let abortController = null; 

    chatMessages.style.display = 'none';

    function toggleSendButton() {
        if (inputField.value.trim().length > 0 && !isStreaming) {
            sendButton.classList.add('active');
        } else {
            sendButton.classList.remove('active');
        }
    }
    inputField.addEventListener('input', toggleSendButton);

    function autoResizeTextarea() {
        const style = getComputedStyle(inputField);
        const line_height_px = parseFloat(style.getPropertyValue('--line-height-px')); 
        const composerPaddingV = 12; 
        const inputContainerPaddingV = 8; 
        const minInputContainerHeight = parseFloat(style.getPropertyValue('--min-input-container-height')); 

        inputField.rows = MIN_ROWS;
        inputField.style.height = 'auto'; 

        let scrollH = inputField.scrollHeight;
        let newRows = Math.round(scrollH / line_height_px);
        newRows = Math.max(MIN_ROWS, Math.min(MAX_ROWS, newRows));
        inputField.rows = newRows;
        inputField.style.height = 'auto';
        
        const finalTextareaHeight = inputField.offsetHeight; 
        const contentHeight = finalTextareaHeight + inputContainerPaddingV;
        const inputContainerHeight = Math.max(contentHeight, minInputContainerHeight);
        
        inputContainer.style.minHeight = `${inputContainerHeight}px`;

        const newComposerHeight = inputContainerHeight + composerPaddingV;
        composer.style.minHeight = `${newComposerHeight}px`;
        
        chatMessages.style.paddingBottom = `${newComposerHeight}px`;

        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    inputField.addEventListener('input', autoResizeTextarea);

    /**
     * ë´‡ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ê³  'ìƒê°í•˜ëŠ” ì¤‘...' í‘œì‹œê¸° í¬í•¨
     * @returns {Object} {indicatorElement, messageBlocksElement, streamingBlockElement}
     */
    function appendBotMessageContainer() {
        const botMessageContainer = document.createElement('div');
        botMessageContainer.className = 'bot-message';
        
        // ğŸ’¡ ìƒê°í•˜ëŠ” ì¤‘... í‘œì‹œê¸°
        const indicatorContainer = document.createElement('div');
        indicatorContainer.id = 'thinking-indicator';
        const indicatorText = document.createElement('span');
        indicatorText.className = 'thinking-indicator-text';
        indicatorText.textContent = 'ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...';
        indicatorContainer.appendChild(indicatorText);
        
        // ğŸŒŸ ì´ë¯¸ ì™„ì„±ëœ ë¸”ë¡ë“¤ì´ ë“¤ì–´ê°ˆ ì»¨í…Œì´ë„ˆ
        const messageBlocks = document.createElement('div');
        messageBlocks.className = 'message-blocks';
        
        // ğŸŒŸ í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°ˆ ì»¨í…Œì´ë„ˆ (Fade-in ì ìš©)
        const streamingBlock = document.createElement('div');
        streamingBlock.className = 'streaming-block new-block-fade'; 
        
        botMessageContainer.appendChild(indicatorContainer);
        botMessageContainer.appendChild(messageBlocks);
        botMessageContainer.appendChild(streamingBlock);

        chatMessages.appendChild(botMessageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        return { 
            indicatorElement: indicatorContainer, 
            messageBlocksElement: messageBlocks,
            streamingBlockElement: streamingBlock 
        };
    }
    
    function startStreamingUI(indicator) {
        // 'ìƒê°í•˜ëŠ” ì¤‘...' ìˆ¨ê¸°ê¸°
        indicator.style.display = 'none';
    }

    /**
     * ì›ë³¸ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * ì´ í•¨ìˆ˜ëŠ” ì´ì œ ì¸ë¼ì¸ ë§ˆí¬ë‹¤ìš´(êµµê²Œ, ì½”ë“œ) ë° ì¤„ë°”ê¿ˆë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     * @param {string} rawText - ë³€í™˜í•  ì›ë³¸ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸.
     */
    function renderInlineMarkdown(rawText) {
        if (!rawText) return "";
        let html = rawText.replace(/\r/g, ''); 
        
        // 1. ì¸ë¼ì¸ ì½”ë“œ `code`
        html = html.replace(/`([^`\n]+?)`/g, '<code>$1</code>');

        // 2. êµµì€ ê¸€ì”¨ **text** ë˜ëŠ” __text__
        html = html.replace(/\*\*([^\*]+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/__([^__]+?)__/g, '<strong>$1</strong>');
        
        // 3. ë‹¨ì¼ ì¤„ë°”ê¿ˆì„ <br>ë¡œ
        html = html.replace(/\n/g, '<br>');

        return html;
    }
    
    /**
     * ì™„ì„±ëœ ë¸”ë¡ì„ ë Œë”ë§í•˜ê³  í˜ì´ë“œì¸ íš¨ê³¼ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
     */
    function appendBlockToContainer(blockContent, container) {
        let element = document.createElement('div');
        element.className = 'bot-message-block new-block-fade'; 
        
        // í—¤ë” ë³€í™˜ (ì—¬ê¸°ì— ëª¨ë“  í—¤ë” ì²˜ë¦¬ë¥¼ ëª°ì•„ë„£ìŠµë‹ˆë‹¤)
        // $1: #+ (e.g., #, ##, ###) / $2: content
        blockContent = blockContent.replace(/^(#+)\s*([^\n]+)/, (match, hashes, content) => {
            return `<h${hashes.length}>${content}</h${hashes.length}>`;
        });
        
        // ì¸ë¼ì¸ ë§ˆí¬ë‹¤ìš´ ë° ì¤„ë°”ê¿ˆ ì²˜ë¦¬
        let blockHtml = renderInlineMarkdown(blockContent);
        
        // ì´ë¯¸ í—¤ë”ë¡œ ë³€í™˜ëœ ê²½ìš°, <p>ë¡œ ê°ì‹¸ì§€ ì•ŠìŠµë‹ˆë‹¤.
        if (blockHtml.match(/<h[1-3]>|<\/h[1-3]>/i) || blockHtml.match(/<pre>|<\/pre>/i)) {
            element.innerHTML = blockHtml;
        } else {
            element.innerHTML = `<p>${blockHtml}</p>`;
        }
        
        container.appendChild(element);

        // ğŸŒŸ í˜ì´ë“œì¸ íš¨ê³¼ ì ìš©
        requestAnimationFrame(() => {
            element.classList.add('visible');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    // ì „ì—­ ë³€ìˆ˜: ì™„ì„±ëœ ë¸”ë¡ì˜ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì 
    let completedRawText = ""; 
    
    /**
     * ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì™„ì„±ëœ ë¸”ë¡ì„ ë¶„ë¦¬í•˜ê³  ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function updateStreamingDisplay(rawResponse, blocksContainer, streamingElement) {
        let currentRawText = rawResponse.substring(completedRawText.length);
        let blocks = [];
        let remainingText = currentRawText;
        
        // ë‹¨ë½ êµ¬ë¶„ì (\n\n)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        let doubleNewlineIndex = currentRawText.indexOf('\n\n');
        
        // ğŸŒŸ í—¤ë”ì™€ ê°•ì œ ì¤„ë°”ê¿ˆì„ ìœ„í•œ ì •ê·œì‹
        // (#+) : í—¤ë” ë§ˆí¬ë‹¤ìš´ / ([^\n]+?([.?!])) : êµ¬ë‘ì ìœ¼ë¡œ ëë‚˜ëŠ” ë‚´ìš© / ([^\n]*) : ë’¤ë”°ë¥´ëŠ” í…ìŠ¤íŠ¸
        const headerRegex = /^(#+)\s*([^\n]+?([.?!]))\s*([^\n]*)/;
        
        let match = currentRawText.match(headerRegex);
        let blockCompleted = false;

        if (doubleNewlineIndex !== -1) {
             // ì¼ë°˜ ë‹¨ë½ìœ¼ë¡œ ë¶„ë¦¬
             let completedBlock = currentRawText.substring(0, doubleNewlineIndex);
             blocks.push(completedBlock);
             remainingText = currentRawText.substring(doubleNewlineIndex + 2);
             blockCompleted = true;
        } else if (match) {
            // í—¤ë” + ê°•ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬
            let contentBeforeTrailing = match[0].substring(0, match[0].length - match[4].length);
            let contentAfterTrailing = match[4];
            
            blocks.push(contentBeforeTrailing);
            remainingText = contentAfterTrailing;
            blockCompleted = true;
        }
        
        // ì™„ì„±ëœ ë¸”ë¡ì´ ìˆë‹¤ë©´ ë Œë”ë§í•˜ê³  ì¶”ì  ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        for (let block of blocks) {
            if (block.trim().length > 0) {
                appendBlockToContainer(block.trim(), blocksContainer);
                // ë¸”ë¡ì´ ì™„ì„±ë˜ë©´ ë’¤ì— \n\nì„ ì¶”ê°€í•˜ì—¬ completedRawTextì— ê¸°ë¡í•©ë‹ˆë‹¤.
                // ì¼ë°˜ ë‹¨ë½ ë¶„ë¦¬ (\n\n) ë˜ëŠ” í—¤ë” ë¶„ë¦¬ ì‹œ ëª¨ë‘ ë‹¨ë½ì´ ì™„ì„±ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
                completedRawText += block + '\n\n'; 
            }
        }
        
        // í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ ë¸”ë¡ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        streamingElement.innerHTML = renderInlineMarkdown(remainingText);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    // ì¤‘ì§€ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë° ìƒíƒœ ì—…ë°ì´íŠ¸
    function setStreamingState(active) {
        isStreaming = active;
        if (active) {
            sendButton.style.display = 'none';
            stopButton.style.display = 'flex';
            inputField.setAttribute('readonly', 'true');
        } else {
            sendButton.style.display = 'flex';
            stopButton.style.display = 'none';
            inputField.removeAttribute('readonly');
            abortController = null;
        }
        toggleSendButton();
    }
    
    // ì¤‘ì§€ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    function stopResponse() {
        if (abortController) {
            abortController.abort();
            
            const lastBotMessageElement = chatMessages.lastElementChild;
            if (lastBotMessageElement) {
                const indicator = lastBotMessageElement.querySelector('#thinking-indicator');
                const streamingBlock = lastBotMessageElement.querySelector('.streaming-block');
                const blocksContainer = lastBotMessageElement.querySelector('.message-blocks');

                // indicatorê°€ ì•„ì§ ë‚¨ì•„ìˆë‹¤ë©´ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šê³  ì‚­ì œ
                if (indicator && indicator.style.display !== 'none') {
                    lastBotMessageElement.remove(); 
                } 
                else if (streamingBlock && streamingBlock.textContent.trim().length > 0) {
                    // í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì´ë˜ ë‚´ìš©ì„ ì™„ì„±ëœ ë¸”ë¡ìœ¼ë¡œ ë Œë”ë§
                    let remainingBlockContent = streamingBlock.textContent.trim();
                    if (remainingBlockContent.length > 0) {
                        appendBlockToContainer(remainingBlockContent, blocksContainer);
                        // completedRawTextëŠ” ìŠ¤íŠ¸ë¦¬ë° ì¤‘ë‹¨ ì‹œì—ëŠ” ì—…ë°ì´íŠ¸í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. (historyì— ìµœì¢… fullResponseê°€ ì €ì¥ë¨)
                    }
                    streamingBlock.remove(); // ìŠ¤íŠ¸ë¦¬ë° ë¸”ë¡ ì œê±°
                } 
            }
        }
        setStreamingState(false);
    }
    stopButton.addEventListener('click', stopResponse);

    // ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
    let fullResponse = ""; 

    async function sendMessage() {
        const userMessage = inputField.value.trim();
        if (userMessage.length === 0 || isStreaming) return;

        // 1. ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸” ì¶”ê°€ ë° history ì—…ë°ì´íŠ¸
        
        if (initialContent.style.opacity !== '0') {
            initialContent.style.opacity = '0';
            setTimeout(() => {
                initialContent.style.display = 'none';
                chatMessages.style.display = 'flex'; 
            }, 500); 
        } else {
             chatMessages.style.display = 'flex';
        }

        const userBubble = document.createElement('div');
        userBubble.className = 'message-bubble user-message';
        userBubble.innerHTML = `<div class="message-text">${userMessage}</div>`;
        chatMessages.appendChild(userBubble);
        
        history.push({ role: 'user', content: userMessage }); 

        // 2. ì…ë ¥ì°½ ì´ˆê¸°í™” ë° UI ìƒíƒœ ì—…ë°ì´íŠ¸
        inputField.value = '';
        inputField.rows = MIN_ROWS; 
        autoResizeTextarea(); 
        
        // 3. ë´‡ ë©”ì‹œì§€ë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ ì¶”ê°€ ë° ë¡œë”© í‘œì‹œ
        const { indicatorElement, messageBlocksElement, streamingBlockElement } = appendBotMessageContainer();
        
        // 4. ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì‹œì‘
        setStreamingState(true);
        abortController = new AbortController();
        const signal = abortController.signal;
        
        fullResponse = ""; 
        completedRawText = ""; // ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ì‹œ ì´ˆê¸°í™”
        let buffer = ""; 
        let isFirstChunk = true; 
        
        try {
            const response = await fetch(BACKEND_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    history: history, 
                }),
                signal: signal 
            });

            if (!response.ok) {
                
                startStreamingUI(indicatorElement); 
                let errorMessage = `HTTP Error: ${response.status} ${response.statusText}`;
                if (response.status === 429) {
                    errorMessage = "âš ï¸ ìš”ì²­ ì†ë„ ì œí•œ ì´ˆê³¼: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
                } else if (response.status === 400) {
                    errorMessage = "âš ï¸ ì˜ëª»ëœ ìš”ì²­: ì…ë ¥ ë©”ì‹œì§€ ê¸¸ì´ ë“±ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                } else if (response.status >= 500) {
                     errorMessage = `âš ï¸ ì„œë²„ ì˜¤ë¥˜: ë°±ì—”ë“œì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (HTTP ${response.status})`;
                }
                
                streamingBlockElement.innerHTML = `<p style="color:red;">${errorMessage}</p>`;
                setStreamingState(false);
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    break;
                }
                
                buffer += decoder.decode(value, { stream: true });
                
                const parts = buffer.split('\n');
                buffer = parts.pop(); 

                for (const part of parts) {
                    const cleanPart = part; 
                    if (cleanPart.trim() === "[DONE]") {
                        // ë‚¨ì€ ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ìµœì¢… ë¸”ë¡ìœ¼ë¡œ ì²˜ë¦¬
                        fullResponse += buffer;
                        updateStreamingDisplay(fullResponse, messageBlocksElement, streamingBlockElement);
                        
                        // ë§ˆì§€ë§‰ ìŠ¤íŠ¸ë¦¬ë° ë¸”ë¡ ì œê±°
                        if (streamingBlockElement) streamingBlockElement.remove();
                        
                        setStreamingState(false);
                        history.push({ role: 'model', content: fullResponse });
                        reader.releaseLock();
                        return; 
                    }
                    
                    if (cleanPart.length > 0) {
                        if (isFirstChunk) {
                            startStreamingUI(indicatorElement); 
                            isFirstChunk = false;
                        }
                        
                        // ì›ë³¸ í…ìŠ¤íŠ¸ ëˆ„ì 
                        fullResponse += cleanPart;
                        
                        // ğŸŒŸğŸŒŸğŸŒŸ ë¶€ë“œëŸ¬ìš´ ìŠ¤íŠ¸ë¦¬ë° ë¡œì§ ğŸŒŸğŸŒŸğŸŒŸ
                        updateStreamingDisplay(fullResponse, messageBlocksElement, streamingBlockElement);
                    }
                }
            }
            
            if (buffer.length > 0) {
                 if (isFirstChunk) {
                    startStreamingUI(indicatorElement);
                    isFirstChunk = false;
                 }
                 fullResponse += buffer;
                 updateStreamingDisplay(fullResponse, messageBlocksElement, streamingBlockElement);
            }
            
            // ìŠ¤íŠ¸ë¦¬ë°ì´ ì •ìƒ ì¢…ë£Œëœ í›„, ë§ˆì§€ë§‰ ìŠ¤íŠ¸ë¦¬ë° ë¸”ë¡ì„ ì™„ì„±ëœ ë¸”ë¡ìœ¼ë¡œ ì²˜ë¦¬
            if (isStreaming) {
                updateStreamingDisplay(fullResponse, messageBlocksElement, streamingBlockElement);
                 if (streamingBlockElement) streamingBlockElement.remove();
                 
                 setStreamingState(false);
                 history.push({ role: 'model', content: fullResponse });
            }


        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Fetch aborted by user or cleanup triggered.');
            } else {
                console.error('Fetch/Streaming Error:', error);
                const errorMsg = `âš ï¸ í†µì‹  ì˜¤ë¥˜: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CORS ì„¤ì • ë˜ëŠ” ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”. (Error: ${error.message})`;
                
                startStreamingUI(indicatorElement);
                streamingBlockElement.innerHTML = `<p style="color:red;">${errorMsg}</p>`;
            }
            setStreamingState(false);
        }
        if(isStreaming) setStreamingState(false);
    }

    sendButton.addEventListener('click', sendMessage);

    // ì—”í„°í‚¤ ë™ì‘
    inputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            if (isMobile()) {
            } else {
                if (e.shiftKey) {
                    setTimeout(autoResizeTextarea, 0); 
                    return; 
                }
                e.preventDefault(); 
                if (sendButton.classList.contains('active') && !isStreaming) {
                    sendMessage();
                }
            }
        }
    });

    // ì´ˆê¸° ìƒíƒœ ë†’ì´ ì¡°ì •
    toggleSendButton();
    autoResizeTextarea();
  </script>
</body>
</html>
