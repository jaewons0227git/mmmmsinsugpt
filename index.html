<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat UI - File Attach & Search Mode</title>
    <link rel="icon" href="https://6967a657d214301950ed7b2b.imgix.net/logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            /* UI Colors */
            --bg-color: #ffffff;
            --text-color: #374151;
            --sub-text-color: #6b7280; /* ÏÑ§Î™Ö ÌÖçÏä§Ìä∏Ïö© */
            
            --sidebar-bg: #f9fafb; 
            --sidebar-hover: #eceef1;
            
            --input-bg: #f4f4f4;
            --icon-color: #9ca3af;
            --btn-disabled-bg: #e5e7eb;
            --btn-disabled-text: #9ca3af;

            --user-bubble-bg: #f3f4f6;
            --user-bubble-text: #1f2937;
            --bot-bubble-text: #111827;

            --modal-bg: #ffffff;
            --modal-text: #374151;
            --modal-sidebar-bg: #f9fafb;
            --modal-hover: #eceef1;
            
            --border-color: #e5e7eb; 
            --shadow-color: rgba(0, 0, 0, 0.1);
            --stopped-text-color: #9ca3af;
            --danger-color: #ef4444;
            --active-search-bg: rgba(56, 189, 248, 0.15); /* ÌïòÎäòÏÉâ Î∞∞Í≤Ω */
            --active-search-text: #0ea5e9; /* ÌïòÎäòÏÉâ ÌÖçÏä§Ìä∏ */

            --window-radius: 20px;
            --btn-radius: 12px;
            --input-radius: 26px;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #ececf1;
            --sub-text-color: #9ca3af;
            
            --sidebar-bg: #181818; 
            --sidebar-hover: #2a2a2a;
            
            --input-bg: #2f2f2f;
            --icon-color: #8e8e8e;
            --btn-disabled-bg: #333333;
            --btn-disabled-text: #555555;
            
            --user-bubble-bg: #2f2f2f;
            --user-bubble-text: #ececf1;
            --bot-bubble-text: #ececf1;

            --modal-bg: #1e1e1e;
            --modal-text: #ececf1;
            --modal-sidebar-bg: #161616;
            --modal-hover: #2c2c2c;
            
            --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.6);
            --stopped-text-color: #6b7280;
            --danger-color: #ef4444;
            --active-search-bg: rgba(14, 165, 233, 0.2);
            --active-search-text: #38bdf8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        html, body, div, textarea { scrollbar-width: none; -ms-overflow-style: none; }
        ::-webkit-scrollbar { display: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100dvh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- UI Components --- */
        #toggle-btn-wrapper { position: fixed; top: 10px; left: 10px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; background: transparent; z-index: 2000; }
        #toggle-btn-wrapper:hover { background-color: var(--sidebar-hover); }
        .sidebar-icon { width: 24px; height: 24px; color: var(--text-color); }

        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1400; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; backdrop-filter: blur(2px); }
        #sidebar-overlay.visible { opacity: 1; visibility: visible; }

        .sidebar { width: 260px; display: flex; flex-direction: column; background-color: var(--sidebar-bg); transition: width 0.3s ease, transform 0.3s ease, background-color 0.3s; overflow: hidden; padding-top: 60px; flex-shrink: 0; border-right: 1px solid var(--border-color); position: relative; z-index: 1500; }
        .sidebar.collapsed { width: 0; padding: 60px 0 0 0; border-right: none; }
        .sidebar-content { display: flex; flex-direction: column; height: 100%; padding: 0 10px 20px 10px; width: 260px; opacity: 1; transition: opacity 0.2s; }
        .sidebar.collapsed .sidebar-content { opacity: 0; pointer-events: none; }

        .new-chat-btn, .menu-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 14px; border-radius: var(--btn-radius); font-size: 14px; color: var(--text-color); cursor: pointer; border: none; background: transparent; text-align: left; white-space: nowrap; transition: background 0.2s; flex-shrink: 0; }
        .new-chat-btn { margin-bottom: 20px; }
        .new-chat-btn.active, .new-chat-btn:hover, .menu-item:hover { background-color: var(--sidebar-hover); }

        .history-label { font-size: 12px; font-weight: 600; color: var(--icon-color); padding: 0 14px; margin-bottom: 8px; margin-top: 10px; }
        .chat-history { flex: 1; overflow-y: auto; margin-bottom: 10px; padding-bottom: 10px; }
        
        .history-item { 
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; padding: 10px 14px; border-radius: var(--btn-radius); 
            font-size: 14px; color: var(--text-color); cursor: pointer; 
            transition: background 0.2s; margin-bottom: 2px; position: relative;
            height: 40px;
        }
        .history-item:hover, .history-item.active { background-color: var(--sidebar-hover); }
        .history-title { 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            flex: 1; padding-right: 10px; pointer-events: none; 
        }
        .history-actions {
            display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            background: linear-gradient(to right, transparent, var(--sidebar-hover) 20%);
            padding-left: 10px;
        }
        .history-item:hover .history-actions { opacity: 1; background-color: var(--sidebar-hover); }
        .history-action-btn {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; color: var(--icon-color); cursor: pointer;
        }
        .history-action-btn:hover { color: var(--text-color); background-color: rgba(0,0,0,0.05); }
        .history-action-btn.delete:hover { color: var(--danger-color); }

        /* Main Area */
        .main { flex: 1; position: relative; display: flex; flex-direction: column; background-color: var(--bg-color); width: 100%; height: 100%; transition: background-color 0.3s; z-index: 1; }
        
        #welcome-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; transition: opacity 0.4s ease, visibility 0.4s; }
        #welcome-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .center-logo-img { width: 80px; height: auto; border-radius: 50%; margin-bottom: 40px; }
        .center-input-wrapper { width: 100%; max-width: 760px; padding: 0 20px; position: relative; }

        /* ÏàòÏ†ïÎê®: ÌïòÎã® Ïó¨Î∞± Ï∂îÍ∞Ä (ÏûÖÎ†•Ï∞ΩÍ≥º Î©îÏãúÏßÄ Í≤πÏπ® Î∞©ÏßÄ) */
        #chat-content { flex: 1; width: 100%; max-width: 800px; margin: 0 auto; padding: 80px 20px 180px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; opacity: 0; visibility: hidden; transition: opacity 0.3s; -webkit-overflow-scrolling: touch; }
        #chat-content.visible { opacity: 1; visibility: visible; }

        .message-row { display: flex; width: 100%; opacity: 0; animation: fadeIn 0.4s ease-out forwards; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .message-row.user { align-items: flex-end; }
        .message-row.bot { align-items: flex-start; }
        
        /* Attachment Bubbles (in chat) */
        .bubble-attachments { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; justify-content: flex-end; }
        .message-row.bot .bubble-attachments { justify-content: flex-start; }
        
        .bubble-image-card {
            width: 100px; height: 100px; border-radius: 12px; overflow: hidden; cursor: pointer;
            border: 1px solid var(--border-color); background-color: var(--input-bg);
            background-size: cover; background-position: center;
        }
        .bubble-file-card {
            display: flex; align-items: center; gap: 8px; padding: 10px;
            background-color: var(--input-bg); border-radius: 12px;
            border: 1px solid var(--border-color); font-size: 13px;
        }

        .bot-bubble-wrapper { display: flex; flex-direction: column; align-items: flex-start; width: 100%; }
        .message-bubble { max-width: 100%; line-height: 1.6; word-break: break-word; border-radius: 20px; }
        .message-bubble.user-content { background-color: var(--user-bubble-bg); color: var(--user-bubble-text); font-size: 15px; padding: 10px 14px; border-top-right-radius: 4px; }
        .message-bubble.bot-content { background-color: transparent; color: var(--bot-bubble-text); font-size: 16px; padding: 12px 16px; padding-left: 0; }
        
        /* Markdown Style for Bot Message */
        .message-bubble.bot-content p { margin-bottom: 10px; }
        .message-bubble.bot-content p:last-child { margin-bottom: 0; }
        .message-bubble.bot-content pre { background: var(--input-bg); padding: 10px; border-radius: 8px; overflow-x: auto; margin-bottom: 10px; }
        .message-bubble.bot-content code { background: var(--input-bg); padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .message-bubble.bot-content pre code { background: transparent; padding: 0; }
        .message-bubble.bot-content ul, .message-bubble.bot-content ol { margin-left: 20px; margin-bottom: 10px; }
        .message-bubble.bot-content h1, .message-bubble.bot-content h2, .message-bubble.bot-content h3 { margin-top: 10px; margin-bottom: 8px; font-weight: 600; }
        .message-bubble.bot-content a { color: var(--active-search-text); text-decoration: none; }
        .message-bubble.bot-content a:hover { text-decoration: underline; }

        .stopped-text { color: var(--stopped-text-color); font-size: 14px; margin-left: 6px; }

        /* Thinking & Actions */
        .thinking-dot { width: 10px; height: 10px; background-color: var(--text-color); border-radius: 50%; margin-left: 4px; animation: breathe 1.2s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } }
        .thinking-text { font-size: 14px; font-weight: 500; background: linear-gradient(to left, #999 0%, #999 40%, #111 50%, #999 60%, #999 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; color: transparent; animation: shimmer 1s linear infinite; cursor: default; margin-left: 2px; }
        [data-theme="dark"] .thinking-text { background: linear-gradient(to left, #666 0%, #666 40%, #fff 50%, #666 60%, #666 100%); background-size: 200% auto; -webkit-background-clip: text; background-clip: text; }
        @keyframes shimmer { from { background-position: 100% center; } to { background-position: -100% center; } }

        .message-actions { display: flex; gap: 4px; margin-top: 6px; opacity: 0; transition: opacity 0.3s; margin-left: -6px; }
        .message-actions.visible { opacity: 1; }
        .action-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: var(--icon-color); cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .action-btn:hover { background-color: var(--sidebar-hover); color: var(--text-color); }
        .action-icon { width: 18px; height: 18px; stroke-width: 2.2; }

        /* Bottom Interface */
        #bottom-interface { position: absolute; bottom: 0; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; padding: 0 20px 0 20px; opacity: 0; transform: translateY(50px); transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.25, 1, 0.5, 1); z-index: 5; pointer-events: none; background: linear-gradient(to top, var(--bg-color) 40%, transparent); }
        #bottom-interface.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        .bottom-input-wrapper { width: 100%; max-width: 760px; position: relative; }
        
        .input-container { display: flex; flex-direction: column; background-color: var(--input-bg); border-radius: var(--input-radius); padding: 10px 10px; box-shadow: 0 0 10px rgba(0,0,0,0.02); transition: background-color 0.3s; position: relative; }
        
        /* Attachment Preview Area inside Input */
        .attachment-preview-area { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 0; margin-bottom: 0; transition: margin 0.2s; }
        .attachment-preview-area.has-items { margin-bottom: 12px; padding-top: 8px; }
        .attach-card { 
            position: relative; width: 60px; height: 60px; flex-shrink: 0; border-radius: 10px; 
            background-color: #ddd; background-size: cover; background-position: center; border: 1px solid var(--border-color); 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .attach-card.file-type { background-color: var(--bg-color); font-size: 10px; color: var(--text-color); flex-direction: column; text-align: center; padding: 2px; }
        .attach-card-remove { 
            position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: var(--text-color); 
            color: var(--bg-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; z-index: 2; border: 1px solid var(--bg-color);
        }
        
        .input-top-row { width: 100%; margin-bottom: 4px; }
        .input-field { width: 100%; border: none; background: transparent; font-size: 16px; outline: none; color: var(--text-color); resize: none; font-family: inherit; overflow-y: auto; height: 24px; line-height: 24px; display: block; max-height: 200px; padding: 4px 0; padding-left: 6px; }
        .input-field::placeholder { color: var(--icon-color); }
        .input-bottom-row { display: flex; justify-content: space-between; align-items: center; height: 36px; }
        
        .left-actions, .right-actions { display: flex; align-items: center; gap: 8px; position: relative; }
        .icon-btn { display: flex; align-items: center; justify-content: center; width: 34px; height: 34px; border-radius: 50%; color: var(--icon-color); cursor: pointer; transition: 0.2s; position: relative; }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); color: var(--text-color); }
        
        /* Search Toggle Button */
        .search-btn {
            display: flex; align-items: center; justify-content: center; 
            height: 34px; border-radius: 17px; padding: 0; width: 34px; 
            background-color: transparent; color: var(--icon-color); 
            cursor: pointer; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden; gap: 0;
        }
        .search-btn:hover { background-color: rgba(0,0,0,0.05); color: var(--text-color); }
        .search-btn.active { background-color: var(--active-search-bg); color: var(--active-search-text); width: auto; padding: 0 12px 0 8px; }
        .search-label { font-size: 13px; font-weight: 600; white-space: nowrap; opacity: 0; width: 0; overflow: hidden; transition: all 0.3s ease; margin-left: 0; }
        .search-btn.active .search-label { opacity: 1; width: auto; margin-left: 6px; }

        /* Plus Menu (Attachment) */
        .attach-menu {
            position: absolute; bottom: 50px; left: 0; background-color: var(--modal-bg);
            border: 1px solid var(--border-color); border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 160px;
            display: flex; flex-direction: column; overflow: hidden;
            opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease; z-index: 20;
        }
        .attach-menu.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .attach-item {
            padding: 10px 14px; display: flex; align-items: center; gap: 10px;
            font-size: 14px; color: var(--text-color); cursor: pointer; transition: background 0.2s;
        }
        .attach-item:hover { background-color: var(--sidebar-hover); }

        .send-btn { display: flex; flex-shrink: 0; align-items: center; justify-content: center; width: 34px; height: 34px; border-radius: 50%; background-color: var(--btn-disabled-bg); color: var(--btn-disabled-text); cursor: default; pointer-events: none; transition: 0.2s; }
        .send-btn.active, .send-btn.stop-active { background-color: #000000; color: #fff; cursor: pointer; pointer-events: auto; }
        [data-theme="dark"] .send-btn.active, [data-theme="dark"] .send-btn.stop-active { background-color: #ffffff; color: #000; }
        .model-selector { display: flex; align-items: center; justify-content: center; gap: 4px; background-color: var(--bg-color); padding: 0 12px; height: 32px; border-radius: 16px; font-size: 13px; color: var(--text-color); cursor: pointer; transition: background-color 0.3s; }
        .model-selector:hover { background-color: var(--sidebar-hover); }

        /* Disclaimer Footer */
        .bottom-disclaimer {
            text-align: center; font-size: 11px; color: #9ca3af; margin-top: 8px; margin-bottom: 20px;
            width: 100%; max-width: 760px;
        }

        /* --- Global Modal (Settings & Dialogs) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        
        /* Image Lightbox */
        .image-lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s;
        }
        .image-lightbox.open { opacity: 1; visibility: visible; }
        .lightbox-img { max-width: 90%; max-height: 90%; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .image-lightbox.open .lightbox-img { transform: scale(1); }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; cursor: pointer; background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Settings Window */
        .settings-window { background-color: var(--modal-bg); width: 750px; height: 500px; border-radius: var(--window-radius); display: flex; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); color: var(--modal-text); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), background-color 0.3s; }
        .modal-overlay.open .settings-window { transform: scale(1); }
        .settings-sidebar { width: 220px; background-color: var(--modal-sidebar-bg); padding: 20px 10px; display: flex; flex-direction: column; gap: 4px; border-right: 1px solid var(--border-color); }
        .settings-nav-item { padding: 12px 16px; border-radius: var(--btn-radius); font-size: 14px; color: var(--text-color); opacity: 0.7; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s, opacity 0.2s; white-space: nowrap; }
        .settings-nav-item:hover { background-color: var(--modal-hover); opacity: 1; }
        .settings-nav-item.active { background-color: var(--modal-hover); opacity: 1; font-weight: 600; }
        .set-icon { width: 18px; height: 18px; flex-shrink: 0; }
        .settings-content { flex: 1; padding: 40px; background-color: var(--modal-bg); position: relative; overflow-y: auto; }
        .settings-header { font-size: 18px; font-weight: 600; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .close-modal-btn { cursor: pointer; color: var(--icon-color); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s; }
        .close-modal-btn:hover { background-color: var(--modal-hover); }
        
        .tab-section { display: none; flex-direction: column; height: 100%; }
        .tab-section.active-tab { display: flex; }

        /* ÏàòÏ†ïÎê®: Info ÌÉ≠ ÏúÑÏπò ÏÉÅÎã®ÏúºÎ°ú Ïù¥Îèô Î∞è ÏïÑÏù¥ÏΩò Î≥ÄÍ≤Ω ÏöîÏ≤≠ Î∞òÏòÅ */
        #tab-info {
            overflow: hidden;
            justify-content: flex-start; /* Ï§ëÏïô(center) ÎåÄÏã† ÏÉÅÎã®(flex-start) */
            align-items: center;
            padding-top: 100px; /* ÏúÑÎ°ú Ïò¨Î¶¨Îêò ÏïΩÍ∞ÑÏùò Ïó¨Î∞± */
        }

        .setting-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 16px 0; border-bottom: 1px solid var(--border-color); }
        .setting-info { display: flex; flex-direction: column; gap: 4px; }
        .setting-label { font-size: 14px; color: var(--text-color); font-weight: 500; }
        .setting-desc { font-size: 12px; color: var(--sub-text-color); }
        
        /* New Inputs for Personalization */
        .setting-textarea { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 14px; resize: vertical; min-height: 80px; outline: none; }
        .setting-textarea:focus { border-color: var(--icon-color); }

        .custom-select-container { position: relative; width: 160px; }
        .custom-select-trigger { display: flex; align-items: center; justify-content: flex-end; gap: 8px; font-size: 14px; color: var(--text-color); cursor: pointer; padding: 8px 12px; border-radius: var(--btn-radius); transition: background-color 0.2s; }
        .custom-select-trigger:hover { background-color: var(--modal-hover); }
        .trigger-arrow { width: 12px; height: 12px; transition: transform 0.2s; }
        .custom-select-container.open .trigger-arrow { transform: rotate(180deg); }
        .custom-options { position: absolute; top: 100%; right: 0; background-color: var(--modal-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); width: 100%; margin-top: 4px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s ease; overflow: hidden; z-index: 10; max-height: 200px; overflow-y: auto; }
        .custom-select-container.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 10px 12px; font-size: 14px; color: var(--text-color); cursor: pointer; transition: background-color 0.1s; text-align: left; }
        .custom-option:hover { background-color: var(--modal-hover); }
        .custom-option.selected { font-weight: 600; background-color: var(--sidebar-hover); }
        
        .danger-btn { color: var(--danger-color); font-size: 14px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: transparent; cursor: pointer; transition: background 0.2s; }
        .danger-btn:hover { background-color: rgba(239, 68, 68, 0.1); }

        /* Toggle Switch */
        .toggle-switch { position: relative; width: 44px; height: 24px; cursor: pointer; }
        .toggle-input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--btn-disabled-bg); transition: .4s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-input:checked + .toggle-slider { background-color: #10a37f; }
        [data-theme="dark"] .toggle-input:checked + .toggle-slider { background-color: #fff; }
        .toggle-input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Custom Dialog (Alert/Confirm/Prompt) */
        .dialog-window {
            background-color: var(--modal-bg); width: 400px; padding: 24px; border-radius: var(--window-radius); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 20px;
            transform: scale(0.9); transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.open .dialog-window { transform: scale(1); }
        .dialog-title { font-size: 18px; font-weight: 600; color: var(--text-color); }
        .dialog-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 14px; outline: none; }
        .dialog-input:focus { border-color: var(--icon-color); }
        .dialog-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .dialog-btn { padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; border: none; font-weight: 500; transition: opacity 0.2s; }
        .dialog-btn.cancel { background: transparent; color: var(--text-color); }
        .dialog-btn.confirm { background: var(--text-color); color: var(--bg-color); }
        .dialog-btn.delete-confirm { background: var(--danger-color); color: #fff; }
        .dialog-btn:hover { opacity: 0.8; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; height: 100%; width: 220px !important; z-index: 1500; transform: translateX(0); transition: transform 0.3s ease; border-top-right-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
            .sidebar.collapsed { width: 220px !important; transform: translateX(-100%); border-right: none; }
            .sidebar-content { opacity: 1 !important; width: 220px !important; }
            .message-bubble { max-width: 100%; }
            #bottom-interface { padding-bottom: 20px; }
            .settings-window { width: 100%; height: 100%; border-radius: 0; flex-direction: column; transform: scale(1) !important; }
            .settings-sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; border-right: none; border-bottom: 1px solid var(--border-color); padding: 10px; gap: 8px; }
            .settings-nav-item { flex: 0 0 auto; padding: 8px 12px; font-size: 13px; border-radius: 20px; background-color: transparent; }
            .settings-nav-item.active { background-color: var(--text-color); color: var(--bg-color); }
            .settings-content { padding: 20px; }
            .center-logo-img { width: 60px; margin-bottom: 20px; }
            .dialog-window { width: 90%; }
        }
    </style>
</head>
<body>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="image-lightbox" class="image-lightbox" onclick="closeImageLightbox()">
        <div class="lightbox-close" onclick="closeImageLightbox()"><svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>
        <img id="lightbox-img" class="lightbox-img" src="" alt="Full view">
    </div>

    <div id="toggle-btn-wrapper" onclick="toggleSidebar()">
        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke-width="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21" stroke-width="2"></line>
        </svg>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <button class="new-chat-btn active" id="newChatBtn" onclick="startNewChat()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span data-i18n="newChat">New Chat</span>
            </button>
            <div class="history-label" data-i18n="history">History</div>
            <div class="chat-history" id="chatHistoryList">
                </div>
            <div class="menu-item" onclick="openSettings()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span data-i18n="settings">Settings</span>
            </div>
        </div>
    </div>

    <div class="main">
        <div id="welcome-screen">
            <div class="center-logo">
                <img src="https://6967a657d214301950ed7b2b.imgix.net/logo.png" alt="Logo" class="center-logo-img">
            </div>
            <div class="center-input-wrapper">
                <div class="input-container">
                    <div id="center-preview" class="attachment-preview-area"></div>
                    <div class="input-top-row">
                        <textarea id="centerInput" class="input-field" placeholder="Send a message" rows="1" data-i18n-placeholder="placeholder"></textarea>
                    </div>
                    <div class="input-bottom-row">
                        <div class="left-actions">
                            <div class="icon-btn" onclick="toggleAttachMenu('center')">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </div>
                            <div class="search-btn" id="centerSearchBtn" onclick="toggleSearchMode('center')">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                                <span class="search-label">Í≤ÄÏÉâ ÌôúÏÑ±Ìôî</span>
                            </div>
                            <div class="attach-menu" id="centerAttachMenu">
                                <div class="attach-item" onclick="handleFileUpload('image', 'center')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> Ïù¥ÎØ∏ÏßÄ
                                </div>
                                <div class="attach-item" onclick="handleFileUpload('file', 'center')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Î¨∏ÏÑú
                                </div>
                                <div class="attach-item" onclick="handleFileUpload('file', 'center')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg> ÌååÏùº
                                </div>
                            </div>
                        </div>
                        <div class="right-actions">
                            <div class="model-selector">minsu-3<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                            <div class="send-btn" id="centerSendBtn" onclick="handleSendClick('center')">
                                <svg class="icon-send" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bottom-disclaimer">
                    MinsuGPTÎäî Ïã§ÏàòÎ•º Ìï† Ïàò ÏûàÏäµÎãàÎã§. Ï§ëÏöîÌïú Ï†ïÎ≥¥Îäî Ïû¨Ï∞® ÌôïÏù∏ÌïòÏÑ∏Ïöî.
                </div>
            </div>
        </div>

        <div id="chat-content"></div>

        <div id="bottom-interface">
            <div class="bottom-input-wrapper">
                <div class="input-container">
                    <div id="bottom-preview" class="attachment-preview-area"></div>
                    <div class="input-top-row">
                        <textarea id="bottomInput" class="input-field" placeholder="Send a message" rows="1" data-i18n-placeholder="placeholder"></textarea>
                    </div>
                    <div class="input-bottom-row">
                        <div class="left-actions">
                            <div class="icon-btn" onclick="toggleAttachMenu('bottom')">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </div>
                            <div class="search-btn" id="bottomSearchBtn" onclick="toggleSearchMode('bottom')">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                                <span class="search-label">Í≤ÄÏÉâ ÌôúÏÑ±Ìôî</span>
                            </div>
                            <div class="attach-menu" id="bottomAttachMenu">
                                <div class="attach-item" onclick="handleFileUpload('image', 'bottom')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> Ïù¥ÎØ∏ÏßÄ
                                </div>
                                <div class="attach-item" onclick="handleFileUpload('file', 'bottom')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Î¨∏ÏÑú
                                </div>
                                <div class="attach-item" onclick="handleFileUpload('file', 'bottom')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg> ÌååÏùº
                                </div>
                            </div>
                        </div>
                        <div class="right-actions">
                            <div class="model-selector">minsu-3<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                            <div class="send-btn" id="bottomSendBtn" onclick="handleSendClick('bottom')">
                                <svg class="icon-send" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bottom-disclaimer">
                    MinsuGPTÎäî Ïã§ÏàòÎ•º Ìï† Ïàò ÏûàÏäµÎãàÎã§. Ï§ëÏöîÌïú Ï†ïÎ≥¥Îäî Ïû¨Ï∞® ÌôïÏù∏ÌïòÏÑ∏Ïöî.
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="hiddenFileInput" style="display:none;" multiple>

    <div id="settings-modal" class="modal-overlay">
        <div class="settings-window">
            <div class="settings-sidebar">
                <div class="settings-nav-item active" onclick="switchSettingsTab('general', this)"><svg class="set-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> <span data-i18n="general">General</span></div>
                <div class="settings-nav-item" onclick="switchSettingsTab('personalization', this)"><svg class="set-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg> <span data-i18n="personalization">Personalization</span></div>
                <div class="settings-nav-item" onclick="switchSettingsTab('dataControls', this)"><svg class="set-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg> <span data-i18n="dataControls">Data Controls</span></div>
                <div class="settings-nav-item" onclick="switchSettingsTab('info', this)"><span style="font-size:18px; line-height:1; display:flex; align-items:center; width:18px; justify-content:center;">üõà</span> <span data-i18n="info">Info</span></div>
            </div>
            <div class="settings-content">
                <div class="settings-header">
                    <span id="settings-header-title" data-i18n="general">General</span>
                    <div class="close-modal-btn" onclick="closeSettings()"><svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>
                </div>
                
                <div id="tab-general" class="tab-section active-tab">
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label" data-i18n="theme">Theme</div>
                            <div class="setting-desc" data-i18n="themeDesc">Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Ïùò Î∞ùÍ∏∞ Î™®ÎìúÎ•º ÏÑ§Ï†ïÌï©ÎãàÎã§.</div>
                        </div>
                        <div class="custom-select-container" id="themeSelect">
                            <div class="custom-select-trigger" onclick="toggleDropdown('themeSelect')">
                                <span id="currentThemeLabel" data-i18n="system">System</span>
                                <svg class="trigger-arrow" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="custom-options">
                                <div class="custom-option selected" onclick="setTheme('system', this)" data-i18n="system">System</div>
                                <div class="custom-option" onclick="setTheme('dark', this)" data-i18n="dark">Dark</div>
                                <div class="custom-option" onclick="setTheme('light', this)" data-i18n="light">Light</div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label" data-i18n="language">Language</div>
                            <div class="setting-desc" data-i18n="langDesc">UI Ïñ∏Ïñ¥Î•º Î≥ÄÍ≤ΩÌï©ÎãàÎã§.</div>
                        </div>
                        <div class="custom-select-container" id="langSelect">
                            <div class="custom-select-trigger" onclick="toggleDropdown('langSelect')">
                                <span id="currentLangLabel">ÌïúÍµ≠Ïñ¥</span>
                                <svg class="trigger-arrow" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="custom-options">
                                <div class="custom-option selected" onclick="setLanguage('ko', 'ÌïúÍµ≠Ïñ¥', this)">ÌïúÍµ≠Ïñ¥</div>
                                <div class="custom-option" onclick="setLanguage('en', 'English', this)">English</div>
                                <div class="custom-option" onclick="setLanguage('ja', 'Êó•Êú¨Ë™û', this)">Êó•Êú¨Ë™û</div>
                                <div class="custom-option" onclick="setLanguage('zh', 'ÁÆÄ‰Ωì‰∏≠Êñá', this)">ÁÆÄ‰Ωì‰∏≠Êñá</div>
                                <div class="custom-option" onclick="setLanguage('es', 'Espa√±ol', this)">Espa√±ol</div>
                                <div class="custom-option" onclick="setLanguage('fr', 'Fran√ßais', this)">Fran√ßais</div>
                                <div class="custom-option" onclick="setLanguage('de', 'Deutsch', this)">Deutsch</div>
                                <div class="custom-option" onclick="setLanguage('ru', '–†—É—Å—Å–∫–∏–π', this)">–†—É—Å—Å–∫–∏–π</div>
                                <div class="custom-option" onclick="setLanguage('it', 'Italiano', this)">Italiano</div>
                                <div class="custom-option" onclick="setLanguage('pt', 'Portugu√™s', this)">Portugu√™s</div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label" data-i18n="deleteAllChats">Delete all chats</div>
                            <div class="setting-desc" data-i18n="deleteAllDesc">Î™®Îì† ÎåÄÌôî Í∏∞Î°ùÏùÑ Î°úÏª¨ÏóêÏÑú ÏòÅÍµ¨ ÏÇ≠Ï†úÌï©ÎãàÎã§.</div>
                        </div>
                        <button class="danger-btn" onclick="confirmDeleteAllChats()" data-i18n="deleteAll">Delete All</button>
                    </div>
                </div>

                <div id="tab-personalization" class="tab-section">
                    <div class="setting-row" style="flex-direction: column; align-items: stretch; gap: 10px;">
                        <div class="setting-info">
                            <div class="setting-label" data-i18n="systemPrompt">System Prompt</div>
                            <div class="setting-desc" data-i18n="systemPromptDesc">Î¥áÏóêÍ≤å ÎπÑÍ≥µÏãùÏ†ÅÏúºÎ°ú Î™ÖÎ†πÌï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>
                        </div>
                        <textarea id="systemPromptInput" class="setting-textarea" placeholder="Ex: ÎÑàÎäî ÏµúÍ≥†Ïùò ÌîÑÎ°úÍ∑∏ÎûòÎ®∏Ïïº..." onchange="savePersonalization()"></textarea>
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label" data-i18n="botTone">Bot Tone</div>
                            <div class="setting-desc" data-i18n="botToneDesc">Î¥áÏùò ÎßêÌà¨Î•º ÏÑ§Ï†ïÌï©ÎãàÎã§.</div>
                        </div>
                        <div class="custom-select-container" id="toneSelect">
                            <div class="custom-select-trigger" onclick="toggleDropdown('toneSelect')">
                                <span id="currentToneLabel" data-i18n="friendly">Friendly</span>
                                <svg class="trigger-arrow" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="custom-options">
                                <div class="custom-option selected" onclick="setTone('friendly', 'ÏπúÏ†àÌï®', this)" data-i18n="friendly">ÏπúÏ†àÌï®</div>
                                <div class="custom-option" onclick="setTone('friend', 'ÏπúÍµ¨', this)" data-i18n="friend">ÏπúÍµ¨</div>
                                <div class="custom-option" onclick="setTone('stiff', 'Îî±Îî±Ìïú', this)" data-i18n="stiff">Îî±Îî±Ìïú</div>
                                <div class="custom-option" onclick="setTone('soft', 'Î∂ÄÎìúÎü¨Ïö¥', this)" data-i18n="soft">Î∂ÄÎìúÎü¨Ïö¥</div>
                                <div class="custom-option" onclick="setTone('enthusiastic', 'Ïó¥Ï†ïÏ†ÅÏù∏', this)" data-i18n="enthusiastic">Ïó¥Ï†ïÏ†ÅÏù∏</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-dataControls" class="tab-section">
                    <div class="setting-row">
                        <div class="setting-info">
                            <div class="setting-label" data-i18n="historyMemory">History Memory</div>
                            <div class="setting-desc" data-i18n="historyMemoryDesc">Ïù¥Ï†Ñ ÎåÄÌôî ÎÇ¥Ïö©ÏùÑ Í∏∞ÏñµÌïòÏó¨ Î¨∏Îß•ÏùÑ Ïú†ÏßÄÌï©ÎãàÎã§.</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" id="historyToggle" onchange="toggleHistoryMemory(this)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div id="tab-info" class="tab-section">
                    <img src="https://6967a657d214301950ed7b2b.imgix.net/logo.png" alt="MinsuGPT Logo" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">MinsuGPT</h2>
                    <div style="font-size: 14px; color: var(--sub-text-color); margin-bottom: 8px;">App Version: 2026211-200B2012</div>
                    <div style="font-size: 12px; color: var(--sub-text-color);">Copyright 2026 MinsuGPT & Shin Jaewon. All Rights Reserved.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="dialog-modal" class="modal-overlay">
        <div class="dialog-window">
            <div class="dialog-title" id="dialog-title">Title</div>
            <input type="text" id="dialog-input" class="dialog-input" style="display:none;">
            <div class="dialog-actions">
                <button class="dialog-btn cancel" onclick="closeDialog()" data-i18n="cancel">Cancel</button>
                <button id="dialog-confirm-btn" class="dialog-btn confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            ko: { newChat: "ÏÉà Ï±ÑÌåÖ", history: "Í∏∞Î°ù", settings: "ÏÑ§Ï†ï", placeholder: "Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞", general: "ÏùºÎ∞ò", personalization: "Í∞úÏù∏ ÎßûÏ∂§ ÏÑ§Ï†ï", dataControls: "Îç∞Ïù¥ÌÑ∞ Ï†úÏñ¥", info: "Ï†ïÎ≥¥", theme: "ÌÖåÎßà", system: "ÏãúÏä§ÌÖú", dark: "Îã§ÌÅ¨", light: "ÎùºÏù¥Ìä∏", language: "Ïñ∏Ïñ¥", deleteAllChats: "Î™®Îì† Ï±ÑÌåÖ ÏÇ≠Ï†ú", deleteAll: "Î™®Îëê ÏÇ≠Ï†ú", cancel: "Ï∑®ÏÜå", delete: "ÏÇ≠Ï†ú", editTitle: "Ïù¥Î¶Ñ ÏàòÏ†ï", deleteConfirmTitle: "Ï±ÑÌåÖ ÏÇ≠Ï†ú", deleteConfirmMsg: "Ïù¥ Ï±ÑÌåÖÏùÑ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?", deleteAllConfirmMsg: "Î™®Îì† Ï±ÑÌåÖ Í∏∞Î°ùÏùÑ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?", themeDesc: "Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Ïùò Î∞ùÍ∏∞ Î™®ÎìúÎ•º ÏÑ§Ï†ïÌï©ÎãàÎã§.", langDesc: "UI Ïñ∏Ïñ¥Î•º Î≥ÄÍ≤ΩÌï©ÎãàÎã§.", deleteAllDesc: "Î™®Îì† ÎåÄÌôî Í∏∞Î°ùÏùÑ Î°úÏª¨ÏóêÏÑú ÏòÅÍµ¨ ÏÇ≠Ï†úÌï©ÎãàÎã§.", systemPrompt: "ÏãúÏä§ÌÖú ÌîÑÎ°¨ÌîÑÌä∏", systemPromptDesc: "Î¥áÏóêÍ≤å ÎπÑÍ≥µÏãùÏ†ÅÏúºÎ°ú Î™ÖÎ†πÌï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.", botTone: "Î¥á ÎßêÌà¨", botToneDesc: "Î¥áÏùò ÎßêÌà¨Î•º ÏÑ§Ï†ïÌï©ÎãàÎã§.", friendly: "ÏπúÏ†àÌï®", friend: "ÏπúÍµ¨", stiff: "Îî±Îî±Ìïú", soft: "Î∂ÄÎìúÎü¨Ïö¥", enthusiastic: "Ïó¥Ï†ïÏ†ÅÏù∏", historyMemory: "ÎåÄÌôî Í∏∞Ïñµ", historyMemoryDesc: "Ïù¥Ï†Ñ ÎåÄÌôî ÎÇ¥Ïö©ÏùÑ Í∏∞ÏñµÌïòÏó¨ Î¨∏Îß•ÏùÑ Ïú†ÏßÄÌï©ÎãàÎã§." },
            en: { newChat: "New Chat", history: "History", settings: "Settings", placeholder: "Send a message", general: "General", personalization: "Personalization", dataControls: "Data Controls", info: "Info", theme: "Theme", system: "System", dark: "Dark", light: "Light", language: "Language", deleteAllChats: "Delete all chats", deleteAll: "Delete All", cancel: "Cancel", delete: "Delete", editTitle: "Edit Title", deleteConfirmTitle: "Delete Chat", deleteConfirmMsg: "Delete this chat permanently?", deleteAllConfirmMsg: "Permanently delete all chat history?", themeDesc: "Set the brightness mode of the interface.", langDesc: "Change the UI language.", deleteAllDesc: "Permanently delete all chat history from local storage.", systemPrompt: "System Prompt", systemPromptDesc: "Instructions for the bot (hidden).", botTone: "Bot Tone", botToneDesc: "Set the tone of the bot.", friendly: "Friendly", friend: "Friend", stiff: "Stiff", soft: "Soft", enthusiastic: "Enthusiastic", historyMemory: "Chat Memory", historyMemoryDesc: "Send previous chat history for context." },
            // (ÎÇòÎ®∏ÏßÄ Ïñ∏Ïñ¥ÎèÑ ÏÉùÎûµ ÏóÜÏù¥ Í∏∞Ï°¥ Ïú†ÏßÄ)
            ja: { newChat: "Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà", history: "Â±•Ê≠¥", settings: "Ë®≠ÂÆö", placeholder: "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°", general: "‰∏ÄËà¨", personalization: "„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫", dataControls: "„Éá„Éº„ÇøÂà∂Âæ°", info: "ÊÉÖÂ†±", theme: "„ÉÜ„Éº„Éû", system: "„Ç∑„Çπ„ÉÜ„É†", dark: "„ÉÄ„Éº„ÇØ", light: "„É©„Ç§„Éà", language: "Ë®ÄË™û", deleteAllChats: "„Åô„Åπ„Å¶„ÅÆ„ÉÅ„É£„ÉÉ„Éà„ÇíÂâäÈô§", deleteAll: "„Åô„Åπ„Å¶ÂâäÈô§", cancel: "„Ç≠„É£„É≥„Çª„É´", delete: "ÂâäÈô§", editTitle: "„Çø„Ç§„Éà„É´Á∑®ÈõÜ", deleteConfirmTitle: "„ÉÅ„É£„ÉÉ„ÉàÂâäÈô§", deleteConfirmMsg: "„Åì„ÅÆ„ÉÅ„É£„ÉÉ„Éà„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", deleteAllConfirmMsg: "„Åô„Åπ„Å¶„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", themeDesc: "„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„ÅÆÊòé„Çã„Åï„É¢„Éº„Éâ„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ", langDesc: "UIË®ÄË™û„ÇíÂ§âÊõ¥„Åó„Åæ„Åô„ÄÇ", deleteAllDesc: "„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Åô„Åπ„Å¶„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÄÇ", systemPrompt: "„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà", systemPromptDesc: "„Éú„ÉÉ„Éà„Å∏„ÅÆÈùûÂÖ¨Âºè„Å™ÊåáÁ§∫„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ", botTone: "Âè£Ë™ø", botToneDesc: "„Éú„ÉÉ„Éà„ÅÆÂè£Ë™ø„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ", friendly: "Ë¶™Âàá", friend: "ÂèãÈÅî", stiff: "Â†Ö„ÅÑ", soft: "Êüî„Çâ„Åã„ÅÑ", enthusiastic: "ÊÉÖÁÜ±ÁöÑ", historyMemory: "‰ºöË©±Ë®òÊÜ∂", historyMemoryDesc: "‰ª•Ââç„ÅÆ‰ºöË©±Â±•Ê≠¥„ÇíË®òÊÜ∂„Åó„Å¶ÊñáËÑà„ÇíÁ∂≠ÊåÅ„Åó„Åæ„Åô„ÄÇ" },
            zh: { newChat: "Êñ∞ËÅäÂ§©", history: "ÂéÜÂè≤ËÆ∞ÂΩï", settings: "ËÆæÁΩÆ", placeholder: "ÂèëÈÄÅÊ∂àÊÅØ", general: "Â∏∏ËßÑ", personalization: "‰∏™ÊÄßÂåñ", dataControls: "Êï∞ÊçÆÊéßÂà∂", info: "‰ø°ÊÅØ", theme: "‰∏ªÈ¢ò", system: "Á≥ªÁªü", dark: "Ê∑±Ëâ≤", light: "ÊµÖËâ≤", language: "ËØ≠Ë®Ä", deleteAllChats: "Âà†Èô§ÊâÄÊúâËÅäÂ§©", deleteAll: "ÂÖ®ÈÉ®Âà†Èô§", cancel: "ÂèñÊ∂à", delete: "Âà†Èô§", editTitle: "ÁºñËæëÊ†áÈ¢ò", deleteConfirmTitle: "Âà†Èô§ËÅäÂ§©", deleteConfirmMsg: "Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÂêóÔºü", deleteAllConfirmMsg: "Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü", themeDesc: "ËÆæÁΩÆÁïåÈù¢ÁöÑ‰∫ÆÂ∫¶Ê®°Âºè„ÄÇ", langDesc: "Êõ¥ÊîπÁïåÈù¢ËØ≠Ë®Ä„ÄÇ", deleteAllDesc: "‰ªéÊú¨Âú∞Â≠òÂÇ®‰∏≠Ê∞∏‰πÖÂà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï„ÄÇ", systemPrompt: "Á≥ªÁªüÊèêÁ§∫", systemPromptDesc: "ËæìÂÖ•ÈùûÊ≠£ÂºèÊåá‰ª§„ÄÇ", botTone: "ËØ≠Ê∞î", botToneDesc: "ËÆæÁΩÆÊú∫Âô®‰∫∫ÁöÑËØ≠Ê∞î„ÄÇ", friendly: "‰∫≤Âàá", friend: "ÊúãÂèã", stiff: "ÁîüÁ°¨", soft: "Ê∏©Êüî", enthusiastic: "ÁÉ≠ÊÉÖ", historyMemory: "ÂØπËØùËÆ∞ÂøÜ", historyMemoryDesc: "ËÆ∞‰Ωè‰ª•ÂâçÁöÑÂØπËØù‰ª•‰øùÊåÅ‰∏ä‰∏ãÊñá„ÄÇ" },
            es: { newChat: "Nuevo Chat", history: "Historial", settings: "Ajustes", placeholder: "Enviar mensaje", general: "General", personalization: "Personalizaci√≥n", dataControls: "Datos", info: "Info", theme: "Tema", system: "Sistema", dark: "Oscuro", light: "Claro", language: "Idioma", deleteAllChats: "Borrar todos los chats", deleteAll: "Borrar todo", cancel: "Cancelar", delete: "Eliminar", editTitle: "Editar t√≠tulo", deleteConfirmTitle: "Eliminar chat", deleteConfirmMsg: "¬øEliminar este chat permanentemente?", deleteAllConfirmMsg: "¬øEliminar permanentemente todo el historial?", themeDesc: "Establece el modo de brillo de la interfaz.", langDesc: "Cambiar el idioma de la interfaz.", deleteAllDesc: "Eliminar permanentemente todo el historial del almacenamiento local.", systemPrompt: "Prompt del sistema", systemPromptDesc: "Instrucciones ocultas para el bot.", botTone: "Tono", botToneDesc: "Establecer el tono del bot.", friendly: "Amable", friend: "Amigo", stiff: "Formal", soft: "Suave", enthusiastic: "Entusiasta", historyMemory: "Memoria", historyMemoryDesc: "Recordar historial para contexto." },
            fr: { newChat: "Nouveau Chat", history: "Historique", settings: "Param√®tres", placeholder: "Envoyer un message", general: "G√©n√©ral", personalization: "Personnalisation", dataControls: "Donn√©es", info: "Info", theme: "Th√®me", system: "Syst√®me", dark: "Sombre", light: "Clair", language: "Langue", deleteAllChats: "Supprimer tout", deleteAll: "Tout supprimer", cancel: "Annuler", delete: "Supprimer", editTitle: "Modifier le titre", deleteConfirmTitle: "Supprimer le chat", deleteConfirmMsg: "Supprimer ce chat d√©finitivement ?", deleteAllConfirmMsg: "Supprimer d√©finitivement tout l'historique ?", themeDesc: "R√©gler la luminosit√© de l'interface.", langDesc: "Changer la langue de l'interface.", deleteAllDesc: "Supprimer d√©finitivement tout l'historique du stockage local.", systemPrompt: "Prompt syst√®me", systemPromptDesc: "Instructions cach√©es pour le bot.", botTone: "Ton", botToneDesc: "D√©finir le ton du bot.", friendly: "Amical", friend: "Ami", stiff: "Rigide", soft: "Doux", enthusiastic: "Enthousiaste", historyMemory: "M√©moire", historyMemoryDesc: "Se souvenir de l'historique pour le contexte." },
            de: { newChat: "Neuer Chat", history: "Verlauf", settings: "Einstellungen", placeholder: "Nachricht senden", general: "Allgemein", personalization: "Personalisierung", dataControls: "Daten", info: "Info", theme: "Design", system: "System", dark: "Dunkel", light: "Hell", language: "Sprache", deleteAllChats: "Alle Chats l√∂schen", deleteAll: "Alle l√∂schen", cancel: "Abbrechen", delete: "L√∂schen", editTitle: "Titel bearbeiten", deleteConfirmTitle: "Chat l√∂schen", deleteConfirmMsg: "Diesen Chat dauerhaft l√∂schen?", deleteAllConfirmMsg: "Gesamten Chatverlauf dauerhaft l√∂schen?", themeDesc: "Helligkeitsmodus der Oberfl√§che festlegen.", langDesc: "UI-Sprache √§ndern.", deleteAllDesc: "Gesamten Chatverlauf dauerhaft vom lokalen Speicher l√∂schen.", systemPrompt: "System Prompt", systemPromptDesc: "Versteckte Anweisungen f√ºr den Bot.", botTone: "Tonfall", botToneDesc: "Tonfall des Bots festlegen.", friendly: "Freundlich", friend: "Freund", stiff: "Steif", soft: "Sanft", enthusiastic: "Begeistert", historyMemory: "Ged√§chtnis", historyMemoryDesc: "Verlauf f√ºr Kontext speichern." },
            ru: { newChat: "–ù–æ–≤—ã–π —á–∞—Ç", history: "–ò—Å—Ç–æ—Ä–∏—è", settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", placeholder: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", general: "–û–±—â–∏–µ", personalization: "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è", dataControls: "–î–∞–Ω–Ω—ã–µ", info: "–ò–Ω—Ñ–æ", theme: "–¢–µ–º–∞", system: "–°–∏—Å—Ç–µ–º–Ω–∞—è", dark: "–¢–µ–º–Ω–∞—è", light: "–°–≤–µ—Ç–ª–∞—è", language: "–Ø–∑—ã–∫", deleteAllChats: "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã", deleteAll: "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ", cancel: "–û—Ç–º–µ–Ω–∞", delete: "–£–¥–∞–ª–∏—Ç—å", editTitle: "–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ", deleteConfirmTitle: "–£–¥–∞–ª–∏—Ç—å —á–∞—Ç", deleteConfirmMsg: "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?", deleteAllConfirmMsg: "–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤ –Ω–∞–≤—Å–µ–≥–¥–∞?", themeDesc: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º —è—Ä–∫–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.", langDesc: "–ò–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.", deleteAllDesc: "–ù–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.", systemPrompt: "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç", systemPromptDesc: "–°–∫—Ä—ã—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –±–æ—Ç–∞.", botTone: "–¢–æ–Ω", botToneDesc: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–Ω –±–æ—Ç–∞.", friendly: "–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π", friend: "–î—Ä—É–≥", stiff: "–°—Ç—Ä–æ–≥–∏–π", soft: "–ú—è–≥–∫–∏–π", enthusiastic: "–í–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–π", historyMemory: "–ü–∞–º—è—Ç—å", historyMemoryDesc: "–ü–æ–º–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞." },
            it: { newChat: "Nuova Chat", history: "Cronologia", settings: "Impostazioni", placeholder: "Invia un messaggio", general: "Generale", personalization: "Personalizzazione", dataControls: "Dati", info: "Info", theme: "Tema", system: "Sistema", dark: "Scuro", light: "Chiaro", language: "Lingua", deleteAllChats: "Elimina tutte le chat", deleteAll: "Elimina tutto", cancel: "Annulla", delete: "Elimina", editTitle: "Modifica titolo", deleteConfirmTitle: "Elimina chat", deleteConfirmMsg: "Eliminare definitivamente questa chat?", deleteAllConfirmMsg: "Eliminare definitivamente tutta la cronologia?", themeDesc: "Imposta la modalit√† di luminosit√† dell'interfaccia.", langDesc: "Cambia la lingua dell'interfaccia.", deleteAllDesc: "Elimina definitivamente tutta la cronologia dalla memoria locale.", systemPrompt: "Prompt di sistema", systemPromptDesc: "Istruzioni nascoste per il bot.", botTone: "Tono", botToneDesc: "Imposta il tono del bot.", friendly: "Amichevole", friend: "Amico", stiff: "Rigido", soft: "Dolce", enthusiastic: "Entusiasta", historyMemory: "Memoria", historyMemoryDesc: "Ricorda la cronologia per il contesto." },
            pt: { newChat: "Novo Chat", history: "Hist√≥rico", settings: "Configura√ß√µes", placeholder: "Enviar mensagem", general: "Geral", personalization: "Personaliza√ß√£o", dataControls: "Dados", info: "Info", theme: "Tema", system: "Sistema", dark: "Escuro", light: "Claro", language: "Idioma", deleteAllChats: "Apagar todas as conversas", deleteAll: "Apagar tudo", cancel: "Cancelar", delete: "Apagar", editTitle: "Editar t√≠tulo", deleteConfirmTitle: "Apagar conversa", deleteConfirmMsg: "Apagar esta conversa permanentemente?", deleteAllConfirmMsg: "Apagar permanentemente todo o hist√≥rico?", themeDesc: "Definir o modo de brilho da interface.", langDesc: "Alterar o idioma da interface.", deleteAllDesc: "Apagar permanentemente todo o hist√≥rico do armazenamento local.", systemPrompt: "Prompt do sistema", systemPromptDesc: "Instru√ß√µes ocultas para o bot.", botTone: "Tom", botToneDesc: "Definir o tom do bot.", friendly: "Amig√°vel", friend: "Amigo", stiff: "R√≠gido", soft: "Suave", enthusiastic: "Entusiasmado", historyMemory: "Mem√≥ria", historyMemoryDesc: "Lembrar hist√≥rico para contexto." }
        };

        let currentLang = 'ko';
        let isGenerating = false;
        let isSearchActive = false;
        let typingTimeout = null;
        let thinkingTimeout = null;
        let currentBubbleElement = null;
        let currentBotRowElement = null; 
        
        // Reader for stream
        let streamReader = null;

        // Data Management Variables
        let currentChatId = null;
        let currentMessages = [];
        let currentAttachments = []; 
        const STORAGE_KEY = 'chat_history_v1';
        
        // Personalization & Settings State
        let systemPrompt = localStorage.getItem('systemPrompt') || '';
        let botTone = localStorage.getItem('botTone') || 'friendly';
        let isHistoryEnabled = localStorage.getItem('isHistoryEnabled') === 'true';

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const newChatBtn = document.getElementById('newChatBtn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatContent = document.getElementById('chat-content');
        const bottomInterface = document.getElementById('bottom-interface');
        const centerInput = document.getElementById('centerInput');
        const centerSendBtn = document.getElementById('centerSendBtn');
        const bottomInput = document.getElementById('bottomInput');
        const bottomSendBtn = document.getElementById('bottomSendBtn');
        const settingsModal = document.getElementById('settings-modal');
        const dialogModal = document.getElementById('dialog-modal');
        const chatHistoryList = document.getElementById('chatHistoryList');
        const hiddenFileInput = document.getElementById('hiddenFileInput');
        const imageLightbox = document.getElementById('image-lightbox');
        const lightboxImg = document.getElementById('lightbox-img');

        const icons = {
            send: '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>',
            stop: '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>',
            copy: '<svg class="action-icon" style="transform: scaleX(-1);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
            check: '<svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>',
            regenerate: '<svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>',
            edit: '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>',
            trash: '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>'
        };

        // --- Initialization ---
        function init() {
            if (window.innerWidth <= 768) sidebar.classList.add('collapsed');
            updateUIText('ko');
            loadHistoryFromStorage();
            
            // Load Settings UI State
            document.getElementById('systemPromptInput').value = systemPrompt;
            document.getElementById('historyToggle').checked = isHistoryEnabled;
            // Tone label update
            const toneKey = botTone;
            if(translations['ko'][toneKey]) {
                document.getElementById('currentToneLabel').innerText = translations['ko'][toneKey];
                // Update selected class
                document.querySelectorAll('#toneSelect .custom-option').forEach(opt => {
                     if(opt.getAttribute('data-i18n') === toneKey) opt.classList.add('selected');
                     else opt.classList.remove('selected');
                });
            }

            const urlParams = new URLSearchParams(window.location.search);
            const chatIdFromUrl = urlParams.get('chat');
            
            if (chatIdFromUrl) {
                loadChat(chatIdFromUrl);
            } else {
                startNewChat(false);
            }
        }

        // --- Search Mode Logic ---
        function toggleSearchMode(origin) {
            isSearchActive = !isSearchActive;
            const btnCenter = document.getElementById('centerSearchBtn');
            const btnBottom = document.getElementById('bottomSearchBtn');
            
            if (isSearchActive) {
                btnCenter.classList.add('active');
                btnBottom.classList.add('active');
            } else {
                btnCenter.classList.remove('active');
                btnBottom.classList.remove('active');
            }
            triggerHaptic();
        }

        // --- File Attachment Logic ---
        function toggleAttachMenu(origin) {
            const menu = document.getElementById(origin + 'AttachMenu');
            const isOpen = menu.classList.contains('open');
            document.querySelectorAll('.attach-menu').forEach(el => el.classList.remove('open'));
            if (!isOpen) menu.classList.add('open');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.attach-menu') && !e.target.closest('.icon-btn')) {
                document.querySelectorAll('.attach-menu').forEach(el => el.classList.remove('open'));
            }
        });

        function handleFileUpload(type, origin) {
            document.querySelectorAll('.attach-menu').forEach(el => el.classList.remove('open'));
            hiddenFileInput.setAttribute('accept', type === 'image' ? 'image/*' : '*/*');
            hiddenFileInput.onchange = (e) => processFiles(e.target.files, origin);
            hiddenFileInput.click();
        }

        async function processFiles(files, origin) {
            if (!files || files.length === 0) return;

            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const compressedDataUrl = await compressImage(file);
                    currentAttachments.push({ type: 'image', data: compressedDataUrl, name: file.name, fileObject: file });
                } else {
                    currentAttachments.push({ type: 'file', name: file.name, size: file.size, fileObject: file });
                }
            }
            renderAttachments();
            hiddenFileInput.value = '';
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        function renderAttachments() {
            const centerPreview = document.getElementById('center-preview');
            const bottomPreview = document.getElementById('bottom-preview');
            
            [centerPreview, bottomPreview].forEach(container => {
                container.innerHTML = '';
                if (currentAttachments.length > 0) container.classList.add('has-items');
                else container.classList.remove('has-items');

                currentAttachments.forEach((att, index) => {
                    const card = document.createElement('div');
                    card.className = `attach-card ${att.type === 'file' ? 'file-type' : ''}`;
                    
                    if (att.type === 'image') {
                        card.style.backgroundImage = `url(${att.data})`;
                        card.onclick = () => openImageLightbox(att.data);
                    } else {
                        card.innerText = "üìÑ\n" + att.name.substring(0, 10) + "...";
                    }

                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'attach-card-remove';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        removeAttachment(index);
                    };

                    card.appendChild(removeBtn);
                    container.appendChild(card);
                });
            });
            
            toggleBtnState(centerInput.value, centerSendBtn);
            toggleBtnState(bottomInput.value, bottomSendBtn);
        }

        function removeAttachment(index) {
            currentAttachments.splice(index, 1);
            renderAttachments();
        }

        // --- Lightbox Logic ---
        function openImageLightbox(src) {
            lightboxImg.src = src;
            imageLightbox.classList.add('open');
        }
        function closeImageLightbox() {
            imageLightbox.classList.remove('open');
            setTimeout(() => { lightboxImg.src = ''; }, 300);
        }

        // --- Data & Storage Logic ---
        function generateId(length = 12) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        function getStoredChats() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } 
            catch { return []; }
        }

        function saveChatToStorage(chatObj) {
            let chats = getStoredChats();
            const existingIndex = chats.findIndex(c => c.id === chatObj.id);
            
            if (existingIndex > -1) {
                chats[existingIndex] = chatObj;
            } else {
                chats.unshift(chatObj); 
            }
            
            chatObj.updatedAt = Date.now();
            chats.sort((a, b) => b.updatedAt - a.updatedAt); 

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    while (chats.length > 0) {
                        chats.pop(); 
                        try {
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
                            break; 
                        } catch (e2) {
                            if (chats.length === 0) break; 
                        }
                    }
                }
            }
            renderHistoryList();
        }

        function deleteChatFromStorage(id) {
            let chats = getStoredChats();
            chats = chats.filter(c => c.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
            renderHistoryList();
        }

        function startNewChat(updateUrl = true) {
            if (isGenerating) stopGeneration();
            currentChatId = generateId();
            currentMessages = [];
            currentAttachments = [];
            renderAttachments();

            chatContent.innerHTML = '';
            welcomeScreen.classList.remove('hidden');
            chatContent.classList.remove('visible');
            bottomInterface.classList.remove('visible');
            newChatBtn.classList.add('active');
            
            centerInput.value = '';
            bottomInput.value = '';
            centerInput.style.height = '24px';
            bottomInput.style.height = '24px';
            toggleBtnState('', centerSendBtn);
            
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            
            if (updateUrl) {
                const url = new URL(window.location);
                url.searchParams.set('chat', currentChatId);
                window.history.pushState({}, '', url);
            }
            if (window.innerWidth <= 768) { sidebar.classList.add('collapsed'); sidebarOverlay.classList.remove('visible'); }
        }

        function loadChat(id) {
            const chats = getStoredChats();
            const chat = chats.find(c => c.id === id);
            
            if (!chat) {
                startNewChat();
                return;
            }

            if (isGenerating) stopGeneration();
            currentChatId = chat.id;
            currentMessages = chat.messages || [];
            currentAttachments = []; 
            renderAttachments();

            welcomeScreen.classList.add('hidden');
            chatContent.classList.add('visible');
            bottomInterface.classList.add('visible');
            newChatBtn.classList.remove('active');
            chatContent.innerHTML = '';

            currentMessages.forEach(msg => {
                if (msg.role === 'user') {
                    appendMessageUI('user', msg.content, false, msg.attachments);
                } else if (msg.role === 'bot') {
                    appendMessageUI('bot', msg.content, false); 
                    const rows = chatContent.querySelectorAll('.message-row.bot');
                    const lastRow = rows[rows.length-1];
                    if(lastRow) {
                       const bubble = lastRow.querySelector('.message-bubble');
                       addActionButtons(lastRow.querySelector('.bot-bubble-wrapper'), bubble.innerText);
                    }
                }
            });

            const url = new URL(window.location);
            url.searchParams.set('chat', currentChatId);
            window.history.pushState({}, '', url);

            renderHistoryList();
            if (window.innerWidth <= 768) { sidebar.classList.add('collapsed'); sidebarOverlay.classList.remove('visible'); }
            scrollToBottom();
        }

        function renderHistoryList() {
            const chats = getStoredChats();
            chatHistoryList.innerHTML = '';
            
            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
                div.onclick = (e) => {
                    if (e.target.closest('.history-action-btn')) return;
                    loadChat(chat.id);
                };

                const titleSpan = document.createElement('span');
                titleSpan.className = 'history-title';
                titleSpan.innerText = chat.title || 'New Conversation';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'history-actions';
                
                const editBtn = document.createElement('div');
                editBtn.className = 'history-action-btn';
                editBtn.innerHTML = icons.edit;
                editBtn.onclick = () => openRenameModal(chat.id, chat.title);
                
                const delBtn = document.createElement('div');
                delBtn.className = 'history-action-btn delete';
                delBtn.innerHTML = icons.trash;
                delBtn.onclick = () => confirmDeleteChat(chat.id);
                
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(delBtn);
                
                div.appendChild(titleSpan);
                div.appendChild(actionsDiv);
                chatHistoryList.appendChild(div);
            });
        }

        function openDialog(title, inputMode, confirmCallback) {
            document.getElementById('dialog-title').innerText = title;
            const input = document.getElementById('dialog-input');
            const confirmBtn = document.getElementById('dialog-confirm-btn');
            
            if (inputMode) {
                input.style.display = 'block';
                input.value = inputMode; 
                input.focus();
                confirmBtn.className = 'dialog-btn confirm';
                confirmBtn.innerText = translations[currentLang].newChat === "New Chat" ? "Save" : "Ï†ÄÏû•";
            } else {
                input.style.display = 'none';
                confirmBtn.className = 'dialog-btn delete-confirm';
                confirmBtn.innerText = translations[currentLang].delete;
            }

            confirmBtn.onclick = () => {
                const val = input.value.trim();
                if (inputMode && !val) return;
                confirmCallback(val);
                closeDialog();
            };

            dialogModal.classList.add('open');
        }

        function closeDialog() {
            dialogModal.classList.remove('open');
        }
        dialogModal.addEventListener('click', (e) => { if (e.target === dialogModal) closeDialog(); });

        function openRenameModal(id, currentTitle) {
            openDialog(translations[currentLang].editTitle, currentTitle || 'New Conversation', (newTitle) => {
                let chats = getStoredChats();
                const chat = chats.find(c => c.id === id);
                if (chat) {
                    chat.title = newTitle;
                    saveChatToStorage(chat);
                }
            });
        }

        function confirmDeleteChat(id) {
            openDialog(translations[currentLang].deleteConfirmMsg, null, () => {
                deleteChatFromStorage(id);
                if (currentChatId === id) {
                    startNewChat();
                }
            });
        }

        function confirmDeleteAllChats() {
            openDialog(translations[currentLang].deleteAllConfirmMsg, null, () => {
                localStorage.removeItem(STORAGE_KEY);
                startNewChat();
                renderHistoryList();
                closeSettings();
            });
        }

        // --- Chat UI Logic ---
        function toggleSidebar() { 
            const isCollapsed = sidebar.classList.toggle('collapsed');
            if (window.innerWidth <= 768) {
                if (!isCollapsed) { sidebarOverlay.classList.add('visible'); } else { sidebarOverlay.classList.remove('visible'); }
            }
        }

        function triggerHaptic() { if (navigator.vibrate) { navigator.vibrate(5); } }
        
        function autoResize(el) {
            el.style.height = '24px';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        }
        
        function scrollToBottom() { chatContent.scrollTop = chatContent.scrollHeight; }

        function toggleBtnState(val, btn) { 
            if (isGenerating) {
                btn.classList.add('stop-active');
            } else {
                (val.trim().length > 0 || currentAttachments.length > 0) ? btn.classList.add('active') : btn.classList.remove('active'); 
                btn.classList.remove('stop-active');
            }
        }
        
        function handleKeydown(e, type) { 
            if (e.isComposing) return; 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                handleSendClick(type); 
            } 
        }

        centerInput.addEventListener('input', function() { autoResize(this); toggleBtnState(this.value, centerSendBtn); });
        centerInput.addEventListener('keydown', (e) => handleKeydown(e, 'center'));
        bottomInput.addEventListener('input', function() { autoResize(this); toggleBtnState(this.value, bottomSendBtn); });
        bottomInput.addEventListener('keydown', (e) => handleKeydown(e, 'bottom'));

        // --- Send & Stream Logic ---
        async function handleSendClick(origin) {
            if (isGenerating) {
                stopGeneration();
                return;
            }

            triggerHaptic(); // Haptic on send

            const input = origin === 'center' ? centerInput : bottomInput;
            const text = input.value.trim();
            if (!text && currentAttachments.length === 0) return;

            const endpoint = isSearchActive 
                ? 'https://jaewondev6.pythonanywhere.com/ask' 
                : 'https://jaewondev6.pythonanywhere.com/askfast';
            
            if (origin === 'center') {
                newChatBtn.classList.remove('active'); 
                welcomeScreen.classList.add('hidden'); 
                chatContent.classList.add('visible'); 
                bottomInterface.classList.add('visible');
            }

            // --- Constructing the Prompt with Personalization ---
            let instructions = "";
            if (systemPrompt) instructions += `[System Instruction: ${systemPrompt}]\n`;
            
            instructions += `[Tone Instruction: Act ${botTone}.`;
            if (['friendly', 'soft', 'stiff'].includes(botTone)) {
                instructions += " Use polite honorifics (korean 'yo/nida').";
            } else if (botTone === 'friend') {
                instructions += " Use casual language (Banmal).";
            }
            instructions += "]\n";

            let finalPrompt = text;
            if (isHistoryEnabled && currentMessages.length > 0) {
                 // Ïù¥Ï†Ñ ÎåÄÌôî 10Í∞úÎßå Í∞ÑÏ∂îÎ†§ÏÑú Ï†ÑÏÜ°
                 const historyText = currentMessages.slice(-10).map(m => `${m.role}: ${m.content}`).join('\n');
                 finalPrompt = `${instructions}\nPrevious Conversation:\n${historyText}\n\nCurrent User Request: ${text}`;
            } else {
                 finalPrompt = `${instructions}\n${text}`;
            }

            // --- Request Setup ---
            let requestBody;
            let requestHeaders = {};

            // ÏàòÏ†ïÎê®: ÌååÏùºÏù¥ ÏóÜÏúºÎ©¥ JSONÏúºÎ°ú, ÏûàÏúºÎ©¥ FormDataÎ°ú Ï†ÑÏÜ° ("Unsupported Media Type" Fix)
            if (currentAttachments.length === 0) {
                requestHeaders['Content-Type'] = 'application/json';
                requestBody = JSON.stringify({ content: finalPrompt });
            } else {
                // FormData (Browser sets Content-Type to multipart/form-data automatically)
                const formData = new FormData();
                formData.append('content', finalPrompt); 
                currentAttachments.forEach(att => {
                    if (att.fileObject) {
                        formData.append('files', att.fileObject);
                    }
                });
                requestBody = formData;
            }

            const attachmentsToSend = [...currentAttachments];
            currentAttachments = [];
            renderAttachments(); 

            input.value = ''; 
            input.style.height = '24px';
            toggleBtnState('', origin === 'center' ? centerSendBtn : bottomSendBtn);

            appendMessageUI('user', text, false, attachmentsToSend);
            
            currentMessages.push({ role: 'user', content: text, attachments: attachmentsToSend });
            
            let chats = getStoredChats();
            let currentChat = chats.find(c => c.id === currentChatId);
            let title = currentChat ? currentChat.title : (text.substring(0, 30) || "Conversation");
            
            saveChatToStorage({
                id: currentChatId,
                title: title,
                messages: currentMessages
            });

            scrollToBottom();
            
            await streamResponse(endpoint, requestHeaders, requestBody);
        }

        // ÏàòÏ†ïÎê®: ÌÉÄÏù¥Ìïë Ìö®Í≥º + Ïä§Ìä∏Î¶¨Î∞ç Î°úÏßÅ
        async function streamResponse(endpoint, headers, body) {
            startGenerationState();
            
            const row = document.createElement('div'); row.className = 'message-row bot';
            const wrapper = document.createElement('div'); wrapper.className = 'bot-bubble-wrapper';
            const bubble = document.createElement('div'); bubble.className = 'message-bubble bot-content';
            
            const dot = document.createElement('div'); dot.className = 'thinking-dot';
            bubble.appendChild(dot);
            
            wrapper.appendChild(bubble);
            row.appendChild(wrapper);
            chatContent.appendChild(row);
            scrollToBottom();
            
            currentBotRowElement = wrapper;
            currentBubbleElement = bubble;
            
            let fullText = ""; // Ïä§Ìä∏Î¶ºÏúºÎ°ú Î∞õÏùÄ Ï†ÑÏ≤¥ ÌÖçÏä§Ìä∏
            let displayedText = ""; // ÌôîÎ©¥Ïóê Î≥¥Ïó¨ÏßÑ ÌÖçÏä§Ìä∏
            let firstChunk = true;

            // ÌÉÄÏù¥Ìïë Ìö®Í≥º Î£®ÌîÑ (Î≠âÌÖÖÏù¥ Î∞©ÏßÄ)
            const typeWriter = setInterval(() => {
                if (displayedText.length < fullText.length) {
                    if (firstChunk) {
                        bubble.innerHTML = ""; // Î°úÎî© Îã∑ Ï†úÍ±∞
                        firstChunk = false;
                        triggerHaptic(); // Start typing haptic
                    }
                    // Ìïú Î≤àÏóê 2~3Í∏ÄÏûêÏî© Ï∂îÍ∞ÄÌïòÏó¨ ÏÜçÎèÑ Ï°∞Ï†à
                    const charsToAdd = fullText.slice(displayedText.length, displayedText.length + 3);
                    displayedText += charsToAdd;
                    bubble.innerHTML = marked.parse(displayedText);
                    scrollToBottom();
                } else if (!isGenerating && displayedText.length === fullText.length) {
                     clearInterval(typeWriter);
                }
            }, 30); // 30ms Í∞ÑÍ≤© ÏóÖÎç∞Ïù¥Ìä∏

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: body
                });

                if (!response.body) throw new Error('ReadableStream not supported');

                streamReader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await streamReader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    fullText += chunk; // Î≤ÑÌçºÏóê Ï∂îÍ∞ÄÎßå Ìï® (UI ÏóÖÎç∞Ïù¥Ìä∏Îäî setIntervalÏù¥ Îã¥Îãπ)
                }

            } catch (error) {
                console.error('Stream error:', error);
                if (currentBubbleElement) {
                    currentBubbleElement.innerHTML += `<br><span class="stopped-text">[Error: ${error.message}]</span>`;
                }
            } finally {
                // Ïä§Ìä∏Î¶º Ï¢ÖÎ£å ÌõÑ UI Í∞±Ïã†Ïù¥ ÏôÑÎ£åÎê† ÎïåÍπåÏßÄ Ïû†Ïãú ÎåÄÍ∏∞
                const checkDone = setInterval(() => {
                    if (displayedText.length >= fullText.length) {
                        clearInterval(checkDone);
                        clearInterval(typeWriter);
                        finishGeneration(fullText);
                    }
                }, 100);
                streamReader = null;
            }
        }

        function appendMessageUI(role, text, isTyping = false, attachments = []) {
            const row = document.createElement('div'); row.className = `message-row ${role}`;
            
            if (attachments && attachments.length > 0) {
                const attachDiv = document.createElement('div');
                attachDiv.className = 'bubble-attachments';
                
                attachments.forEach(att => {
                    const card = document.createElement('div');
                    if (att.type === 'image') {
                        card.className = 'bubble-image-card';
                        card.style.backgroundImage = `url(${att.data})`;
                        card.onclick = () => openImageLightbox(att.data);
                    } else {
                        card.className = 'bubble-file-card';
                        card.innerText = "üìÑ " + att.name;
                    }
                    attachDiv.appendChild(card);
                });
                row.appendChild(attachDiv);
            }

            if (role === 'bot') {
                const wrapper = document.createElement('div'); wrapper.className = 'bot-bubble-wrapper';
                const bubble = document.createElement('div'); bubble.className = `message-bubble ${role}-content`;
                wrapper.appendChild(bubble);
                row.appendChild(wrapper);
                chatContent.appendChild(row);
                
                currentBotRowElement = wrapper;
                bubble.innerHTML = marked.parse(text);
                
                const lastRow = chatContent.querySelectorAll('.message-row.bot');
                if(lastRow.length > 0) {
                    addActionButtons(wrapper, text);
                }
            } else {
                if (text) {
                    const bubble = document.createElement('div'); bubble.className = `message-bubble ${role}-content`;
                    bubble.innerText = text;
                    row.appendChild(bubble);
                }
                chatContent.appendChild(row);
            }
            
            scrollToBottom();
            return row;
        }

        function startGenerationState() {
            isGenerating = true;
            centerSendBtn.innerHTML = icons.stop;
            bottomSendBtn.innerHTML = icons.stop;
            centerSendBtn.classList.add('stop-active');
            bottomSendBtn.classList.add('stop-active');
        }

        function addActionButtons(wrapperElement, bubbleText) {
            if (!wrapperElement) return;
            if (wrapperElement.querySelector('.message-actions')) return; 

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            
            const copyBtn = document.createElement('div');
            copyBtn.className = 'action-btn';
            copyBtn.innerHTML = icons.copy;
            copyBtn.onclick = function() {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = bubbleText;
                const textToCopy = tempDiv.innerText || bubbleText;
                
                navigator.clipboard.writeText(textToCopy.replace('[ÎãµÎ≥Ä Ï§ëÏßÄÎê®]', '')).then(() => {
                    copyBtn.innerHTML = icons.check; 
                    setTimeout(() => { copyBtn.innerHTML = icons.copy; }, 2000);
                });
            };

            const regenBtn = document.createElement('div');
            regenBtn.className = 'action-btn';
            regenBtn.innerHTML = icons.regenerate;
            regenBtn.onclick = function() {
                const rowToRemove = wrapperElement.closest('.message-row');
                if (rowToRemove) rowToRemove.remove();
                
                if (currentMessages.length > 0 && currentMessages[currentMessages.length-1].role === 'bot') {
                    currentMessages.pop();
                }
                
                const lastUserMsg = currentMessages.slice().reverse().find(m => m.role === 'user');
                if(lastUserMsg) {
                    const endpoint = isSearchActive 
                        ? 'https://jaewondev6.pythonanywhere.com/ask' 
                        : 'https://jaewondev6.pythonanywhere.com/askfast';
                    
                    // Regenerate without attachments logic for simplicity or re-add logic here
                    // Using simple JSON regen
                    streamResponse(endpoint, {'Content-Type': 'application/json'}, JSON.stringify({ content: lastUserMsg.content }));
                }
            };

            actionsDiv.appendChild(copyBtn);
            actionsDiv.appendChild(regenBtn);
            wrapperElement.appendChild(actionsDiv);

            requestAnimationFrame(() => {
                actionsDiv.classList.add('visible');
                scrollToBottom();
            });
        }

        function finishGeneration(finalText) {
            isGenerating = false;
            
            if (currentBotRowElement && currentBubbleElement) {
                addActionButtons(currentBotRowElement, finalText);
            }

            if (finalText) {
                currentMessages.push({ role: 'bot', content: finalText });
                let chats = getStoredChats();
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    chat.messages = currentMessages;
                    saveChatToStorage(chat);
                }
            }

            currentBubbleElement = null;
            currentBotRowElement = null;
            
            centerSendBtn.innerHTML = icons.send;
            bottomSendBtn.innerHTML = icons.send;
            centerSendBtn.classList.remove('stop-active');
            bottomSendBtn.classList.remove('stop-active');
            
            toggleBtnState(centerInput.value, centerSendBtn);
            toggleBtnState(bottomInput.value, bottomSendBtn);
        }

        function stopGeneration() {
            if (streamReader) {
                streamReader.cancel();
            }

            let finalText = "";
            if (currentBubbleElement) {
                const stopSpan = document.createElement('span');
                stopSpan.className = 'stopped-text';
                stopSpan.innerText = " [ÎãµÎ≥Ä Ï§ëÏßÄÎê®]";
                currentBubbleElement.appendChild(stopSpan);
                finalText = currentBubbleElement.innerHTML; 
            }
            // Force finish immediately
            isGenerating = false;
            finishGeneration(finalText);
        }

        // --- Settings & Utils ---
        function loadHistoryFromStorage() { renderHistoryList(); }
        function openSettings() { settingsModal.classList.add('open'); if(window.innerWidth <= 768) { sidebar.classList.add('collapsed'); sidebarOverlay.classList.remove('visible'); } }
        function closeSettings() { settingsModal.classList.remove('open'); document.querySelectorAll('.custom-select-container').forEach(el => el.classList.remove('open')); }
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettings(); });
        function toggleDropdown(id) { const el = document.getElementById(id); document.querySelectorAll('.custom-select-container').forEach(item => { if (item.id !== id) item.classList.remove('open'); }); el.classList.toggle('open'); }
        function setTheme(mode, optionEl) { const container = document.getElementById('themeSelect'); container.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected')); optionEl.classList.add('selected'); const key = optionEl.getAttribute('data-i18n'); document.getElementById('currentThemeLabel').innerText = translations[currentLang][key]; container.classList.remove('open'); if (mode === 'system') { const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches; document.body.setAttribute('data-theme', isDark ? 'dark' : 'light'); } else { document.body.setAttribute('data-theme', mode); } }
        function setLanguage(langCode, label, optionEl) { const container = document.getElementById('langSelect'); container.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected')); optionEl.classList.add('selected'); document.getElementById('currentLangLabel').innerText = label; container.classList.remove('open'); currentLang = langCode; updateUIText(langCode); renderHistoryList(); }
        
        // Settings - Personalization Handlers
        function savePersonalization() {
            systemPrompt = document.getElementById('systemPromptInput').value;
            localStorage.setItem('systemPrompt', systemPrompt);
        }
        function setTone(toneValue, label, optionEl) {
            const container = document.getElementById('toneSelect');
            container.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
            optionEl.classList.add('selected');
            document.getElementById('currentToneLabel').innerText = label; 
            container.classList.remove('open');
            botTone = toneValue;
            localStorage.setItem('botTone', botTone);
        }
        function toggleHistoryMemory(checkbox) {
            isHistoryEnabled = checkbox.checked;
            localStorage.setItem('isHistoryEnabled', isHistoryEnabled);
        }

        function updateUIText(lang) { const t = translations[lang]; if (!t) return; document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (t[key]) el.innerText = t[key]; }); document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { const key = el.getAttribute('data-i18n-placeholder'); if (t[key]) el.placeholder = t[key]; }); const currentThemeKey = document.querySelector('#themeSelect .custom-option.selected').getAttribute('data-i18n'); if (currentThemeKey && t[currentThemeKey]) document.getElementById('currentThemeLabel').innerText = t[currentThemeKey]; 
            // Tone Label update
            const toneKey = botTone;
            if(t[toneKey]) document.getElementById('currentToneLabel').innerText = t[toneKey];
        }
        document.addEventListener('click', function(e) { if (!e.target.closest('.custom-select-container')) { document.querySelectorAll('.custom-select-container').forEach(el => el.classList.remove('open')); } });

        function switchSettingsTab(tabName, navItem) {
            document.querySelectorAll('.settings-nav-item').forEach(el => el.classList.remove('active'));
            if(navItem) navItem.classList.add('active');
            document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active-tab'));
            const target = document.getElementById('tab-' + tabName);
            if(target) target.classList.add('active-tab');
            const key = navItem ? navItem.querySelector('span:not(.set-icon)').getAttribute('data-i18n') : 'general';
            document.getElementById('settings-header-title').innerText = translations[currentLang][key] || key;
        }

        init();
    </script>
</body>
</html>
